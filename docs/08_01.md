# 1. Les plugins de recherche (lookup)

## 1.1. Que sont les plugins de recherche ?

Les plugins de recherche (**lookup plugins**) sont une extension spécifique à **Ansible** du langage de templating **Jinja2**.

Ils permettent d'accéder à des données provenant de sources externes (fichiers, bases de données, stores clé/valeur, APIs, et autres services) dans vos **playbooks**.

Vous pouvez utiliser les **plugins** de recherche partout où vous pouvez utiliser le templating dans **Ansible** : dans un **playbook**, dans un fichier de variables, ou dans un template **Jinja2**.

## 1.2. Liste des plugins de recherche

Il existe un grand nombre de plugins disponibles mais nous allons voir uniquement les plugins officiels de l'espace `ansible.builtin.`.

- **ansible.builtin.config** : recherche les valeurs de configuration actuelle d'Ansible, utile pour obtenir des paramètres définis dans **ansible.cfg**.
- **ansible.builtin.csvfile** : lit les données d'un fichier **CSV** ou **TSV**, permettant d'extraire et de manipuler des données tabulaires.
- **ansible.builtin.dict** : retourne les paires clé/valeur d'un dictionnaire, utile pour transformer des dictionnaires en listes de paires clé/valeur.
- a**nsible.builtin.env** : lit la valeur des variables d'environnement, pratique pour accéder aux variables système.
- **ansible.builtin.file** : lit le contenu d'un fichier, permettant d'inclure ce contenu dans des templates ou des variables.
- **ansible.builtin.fileglob** : liste les fichiers correspondant à un motif spécifique, utile pour obtenir une liste de fichiers correspondant à un pattern.
- **ansible.builtin.first_found** : retourne le premier fichier trouvé dans une liste, pratique pour trouver et utiliser le premier fichier existant parmi plusieurs options.
- **ansible.builtin.indexed_items**: réécrit les listes pour retourner des éléments indexés, utile pour créer des paires index/valeur à partir de listes.
- **ansible.builtin.ini** : lit les données d'un fichier INI, permettant d'extraire et d'utiliser les données des fichiers de configuration INI.
- **ansible.builtin.inventory_hostnames** : liste les hôtes de l'inventaire correspondant à un motif d'hôte, utile pour obtenir une liste d'hôtes à partir de l'inventaire Ansible.
- **ansible.builtin.items** : liste des éléments, utilisé pour créer des boucles sur une liste d'éléments.
- **ansible.builtin.lines** : lit les lignes d'une commande, pratique pour exécuter une commande et traiter ses lignes de sortie.
- **ansible.builtin.list** : retourne simplement ce qui lui est donné, utile pour retourner des listes telles quelles.
- **ansible.builtin.nested** : compose une liste avec des éléments imbriqués d'autres listes, permettant de créer des combinaisons de listes imbriquées.
- **ansible.builtin.password** : récupère ou génère un mot de passe aléatoire stocké dans un fichier, utile pour générer des mots de passe sécurisés.
- **ansible.builtin.pipe** : lit la sortie d'une commande, permettant d'exécuter une commande et d'utiliser sa sortie.
- **ansible.builtin.random_choice** : retourne un élément aléatoire d'une liste, pratique pour sélectionner un élément aléatoire.
- **ansible.builtin.sequence** : génère une liste basée sur une séquence de nombres, utile pour créer des séquences numériques.
- **ansible.builtin.subelements** : parcourt une clé imbriquée d'une liste de dictionnaires, pratique pour accéder à des éléments imbriqués dans des dictionnaires.
- **ansible.builtin.template** : récupère le contenu d'un fichier après templating avec Jinja2, permettant de générer des fichiers de configuration dynamiques.
- **ansible.builtin.together** : fusionne des listes en une liste synchronisée, utile pour combiner plusieurs listes en une seule.
- **ansible.builtin.unvault** : lit le contenu des fichiers mis dans le coffre, permettant d'accéder aux données chiffrées.
- **ansible.builtin.url** : retourne le contenu d'une URL, pratique pour récupérer des données à partir d'une URL.
- **ansible.builtin.varnames** : recherche les noms de variables correspondantes, utile pour trouver les noms de variables dans le contexte Ansible.
- **ansible.builtin.vars** : recherche la valeur template des variables, permettant d'obtenir la valeur templatisée des variables dans Ansible.

## 1.3. Exemples d'utilisation

### Lire le contenu d'un fichier

Utilisation du plugin `ansible.builtin.file` pour lire le contenu d'un fichier et l'utiliser dans une tâche Ansible.

```YAML
- name: Read the contents of the file
  hosts: localhost
  vars:
    file_contents: "{{ lookup('ansible.builtin.file', 'path/to/file.txt') }}"
  tasks:
    - name: Show file contents
      debug:
        msg: "{{ file_contents }}"
```

### Lire une variable d'environnement

Utilisation du plugin `ansible.builtin.env` pour lire la valeur d'une variable d'environnement.

```YAML
- name: Read an environment variable
  hosts: localhost
  tasks:
    - name: Show PATH variable
      debug:
        msg: "The PATH variable is : {{ lookup('ansible.builtin.env', 'PATH') }}"
```

## 1.4. Contrôle des erreurs

Vous pouvez contrôler le comportement des erreurs dans tous les plugins de recherche en définissant **errors** à **ignore**, **warn**, ou **strict**.

Le paramètre par défaut est **strict**, ce qui provoque l'échec de la tâche si la recherche retourne une erreur.

### Exemple pour ignorer les erreurs de recherche

```YAML
- name: if this file does not exist, ignore
  debug:
    msg: "{{ lookup('file', '/nosuchfile', errors='ignore') }}"
```

### Exemple pour obtenir un avertissement au lieu d'un échec

```YAML
- name: if this file does not exist, let me know but continue
  debug:
    msg: "{{ lookup('file', '/nosuchfile', errors='warn') }}"
```

## 1.5. Forcer les recherches à retourner des listes : query et wantlist=True

Le comportement par défaut de **lookup** est de retourner une chaîne de valeurs séparées par des virgules.

Vous pouvez explicitement configurer **lookup** pour retourner une liste en utilisant `wantlist=True`.

Exemple d'utilisation de **lookup** pour retourner une liste

```YAML
lookup('dict', dict_variable, wantlist=True)
```

Vous pouvez aussi utiliser **query** qui revient à utiliser `wantlist=True` :

```YAML
query('dict', dict_variable)
```