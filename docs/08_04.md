# 4. Les boucles avec until

## 4.1. Le mot clé until

Le mot-clé **until** permet de réessayer une tâche jusqu'à ce qu'une condition spécifique soit remplie.

Cette fonctionnalité est utile pour des opérations qui peuvent échouer temporairement mais sont susceptibles de réussir après quelques essais, comme la vérification de la disponibilité d'un service ou l'attente de l'apparition d'un fichier.

Les deux paramètres sont :

- **retries** : nombre maximum de tentatives.
- **delay** : délai en secondes entre chaque tentative.

## 4.2. Exemples d'utilisation

### Vérifier la disponibilité d'un service

```YAML
- name: Check web service availability
  ansible.builtin.uri:
    url: http://example.fr/status
    method: GET
  register: service_status
  until: service_status.status == 200
  retries: 10
  delay: 5
```

Dans cet exemple, la tâche vérifie la disponibilité d'un service web en effectuant une requête GET sur l'URL [http://example.fr/status](http://example.fr/status).

La tâche est réessayée jusqu'à ce que le code de statut **HTTP** soit **200 (OK)**, avec un maximum de 10 tentatives et un délai de 5 secondes entre chaque tentative.

#### Attendre qu'un processus se termine

```YAML
- name: Check if the process is complete
  ansible.builtin.shell: pgrep -f my_process
  register: process_status
  until: process_status.rc != 0
  retries: 15
  delay: 4
```

Dans cet exemple, la tâche utilise la commande **pgrep** pour vérifier si un processus nommé **my_process** est en cours d'exécution. La tâche est réessayée jusqu'à ce que le processus ne soit plus trouvé (**pgrep** retourne un code de retour différent de 0), avec un maximum de 15 tentatives et un délai de 4 secondes entre chaque tentative.

#### Réessayer avec une boucle

```YAML
- name: Check websites availability
  ansible.builtin.uri:
    url: "https://{{ item }}.example.fr"
    method: GET
  register: uri_status
  until: uri_status.status == 200
  retries: 3
  delay: 2
  loop:
    - "site1"
    - "site2"
    - "site3"
```

Dans cet exemple, la tâche vérifie la disponibilité de plusieurs sites web. Chaque URL est vérifiée jusqu'à trois fois avec un délai de 2 secondes entre chaque tentative, jusqu'à ce que la condition **status == 200** soit remplie.

#### Enregistrer les tentatives

Lorsque vous utilisez **until** avec **register**, la variable enregistrée inclut une clé **attempts** qui enregistre le nombre de tentatives effectuées pour la tâche.

```YAML
- name: Retry a task and save attempts
  ansible.builtin.shell: /usr/bin/foo
  register: result
  until: result.stdout.find("success") != -1
  retries: 5
  delay: 5

- name: Show number of attempts
  ansible.builtin.debug:
    msg: "Number of attempts: {{ result.attempts }}"
```