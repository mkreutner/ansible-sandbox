# 1. Ansible Vault

## 1.1. Qu'est-ce qu'Ansible Vault ?

**Ansible Vault** est une fonctionnalité permettant de sécuriser des données sensibles telles que des mots de passe ou des clés (**clés SSH**, **secrets**, **clés privées**, **certificats TLS**, etc.). 

Ces données sont protégées au repos (**at rest**), c'est-à-dire lorsqu'elles ne sont pas en cours d'utilisation dans des **playbooks** ou des rôles.

**Ansible Vault** supporte deux types de contenu chiffré : les fichiers intégralement chiffrés et les variables chiffrées.

## 1.2. Fichiers chiffrés

Ces fichiers sont entièrement chiffrés et peuvent contenir des variables ou tout autre type de contenu.

### 1.2.1. Créer un fichier chiffré

Pour créer un fichier chiffré, utilisez la commande **ansible-vault create**. Cette commande vous invite à définir un mot de passe et ouvre un éditeur de texte pour que vous puissiez ajouter vos données sensibles.

```SHELL
ansible-vault create vars/mysql-secrets.yml
```

La définition d'un mot de passe vous sera demandé, il doit bien sûr être sécurisé !

Le fichier chiffré ressemblera ensuite à ça :

```TEXT
$ANSIBLE_VAULT;1.1;AES256
36616334326365346535336265396662323837383437373039616231636362323534613262646231
6235306464333863356637363430326563323230343036330a636137366465366532356466346137
34356338323361356431376234646536363936656135316364326432393265633834386337643563
3938663030373963330a646664333433613262656431353135346233303236643837623330323832
6633
```

### 1.2.2. Editer un fichier chiffré

Pour modifier un fichier chiffré, utilisez la commande **ansible-vault edit** :

```SHELL
ansible-vault edit vars/mysql-secrets.yml
```

### 1.2.3. Chiffrer / déchiffrer des fichiers existants

Pour chiffrer un fichier existant qui n'est pas encore chiffré, utilisez **ansible-vault encrypt** :

```SHELL
ansible-vault encrypt vars/variables.yml
```

Pour déchiffrer un fichier chiffré afin de le rendre en clair, utilisez **ansible-vault decrypt** :

```SHELL
ansible-vault decrypt vars/variables.yml
```

### 1.2.4. Afficher le contenu d'un fichier chiffré

Pour afficher le contenu d'un fichier chiffré sans le modifier, utilisez **ansible-vault view** :

```SHELL
ansible-vault view vars/mysql-secrets.yml
```

### 1.2.5. Créer une variable chiffrée et l'utiliser directement dans un playbook

Vous pouvez aussi créer une variable chiffrée :

```SHELL
ansible-vault encrypt_string 'secret-text' --name 'secret'
```

La commande vous retournera par exemple :

```TEXT
Encryption successful
secret: !vault |
          $ANSIBLE_VAULT;1.1;AES256
          31323236336532343431313639376230303038313930316330386638393635363332373135666433
          3064663633393734663261366230653837333934336562320a396664623534366132363034373932
          38333865356131323833663863663633613035633562616537636333653532613063353338366539
          3137363933306435340a303065356535303365393630663932613530376637613263306532366332
          6137
```

Vous pouvez alors l'utiliser directement dans un **playbook** :

```YAML
---
- hosts: localhost
  vars:
    - secret: !vault |
        $ANSIBLE_VAULT;1.1;AES256
        31323236336532343431313639376230303038313930316330386638393635363332373135666433
        3064663633393734663261366230653837333934336562320a396664623534366132363034373932
        38333865356131323833663863663633613035633562616537636333653532613063353338366539
        3137363933306435340a303065356535303365393630663932613530376637613263306532366332
        6137
  tasks:
    - name: Show secret variable
      ansible.builtin.debug:
        var: secret
```

## 1.3. Utilisation des fichiers chiffrés dans un playbook

Pour utiliser des variables chiffrées dans un playbook, vous pouvez les inclure avec l'instruction vars_files.

```YAML
- hosts: web
  become: yes
  vars_files:
    - vars/main.yml
    - vars/mysql-secrets.yml
  roles:
    - web

- hosts: db
  become: yes
  vars_files:
    - vars/main.yml
    - vars/mysql-secrets.yml
  roles:
    - database
```

Pour exécuter ce playbook et fournir le mot de passe Vault :

```SHELL
ansible-playbook playbook.yml --ask-vault-pass
```