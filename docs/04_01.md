# 1. Syntaxe et format des playbooks

## 1.1. Les playbooks Ansible

Les **playbooks** sont des systèmes de gestion de configuration et de déploiement multi-machines, à la fois simples et réutilisables.

Idéals pour déployer des applications complexes, ils deviennent un outil indispensable dès que vous avez besoin d'exécuter une tâche plus d'une fois, ou que vous souhaitez exécuter plusieurs tâches.

En plaçant vos **playbooks** sous contrôle de version (avec **Git**), vous pouvez facilement déployer de nouvelles configurations ou vérifier celles des systèmes distants.

**Caractéristiques principales**

- **Déclaration de configurations** : définissez les configurations souhaitées pour vos systèmes.
- **Orchestration de processus** : automatisez des étapes manuelles ordonnées sur plusieurs machines.
- **Exécution synchrone ou asynchrone** : lancez des tâches en même temps ou de manière différée.

## 1.2. Syntaxe des playbooks

Les **playbooks** sont écrits en **YAML**, comme tous les autres fichiers de configuration.

Chaque **playbook** est composé d'un ou plusieurs '**plays**', chacun contenant une série de tâches (**tasks**) et des cibles.

Chaque tâche fait appel à un module **Ansible**.

La syntaxe est la suivante :

```YAML
---
- name: Play 1 name
  hosts: targets_play_1
  tasks:
    - name: First task name
      name.module.task1:
        param1: arg1

    - name: Second tak name
      name.module.task2:
        param2: arg2

- name: Play 2 name
  hosts: targets_play_2
  tasks:
    - name: Third task name
      name.module.task3:
        param3: arg3

    - name: Fourth task name
      name.module.task4:
        param4: arg4
```

Par exemple :

```YAML
---
- name: Udate web servers
  hosts: webservers
  remote_user: root

  tasks:
  - name: Ensure Apache is at the latest version
    ansible.builtin.yum:
      name: httpd
      state: latest

- name: Update database servers
  hosts: databases
  remote_user: root

  tasks:
  - name: Ensure PostgreSQL is at the latest version
    ansible.builtin.yum:
      name: postgresql
      state: latest

  - name: Ensure PostgreSQL is started
    ansible.builtin.service:
      name: postgresql
      state: started
```

Ce **playbook** **Ansible** contient deux "**plays**" distincts destinés à la gestion de serveurs distincts dans une infrastructure typique :

- un **play** pour les serveurs Web (le premier)
- un **play** pour les serveurs de base de données (le second)

## 1.3. Exécution des playbooks

Un **playbook** s'exécute de **haut** en **bas**.

Dans chaque **play**, les tâches sont également exécutées dans l'ordre.

Vous pouvez orchestrer des déploiements sur plusieurs types de machines : d'abord les serveurs web, puis les bases de données, et ainsi de suite.

**Idempotence et état souhaité**

La plupart des modules **Ansible** vérifient si l'état désiré est déjà atteint et ne font rien si c'est le cas.

Cette caractéristique, appelée '**idempotence**', assure que l'exécution répétée d'un **playbook** produit toujours le même état final.

**Lancer l'exécution**

Pour exécuter un **playbook**, utilisez la commande **ansible-playbook**.

Par exemple, pour exécuter un **playbook** nommé **playbook.yml** :

```SHELL
ansible-playbook playbook.yaml
```

**Mode de vérification (check mode)**

Le mode de vérification permet de simuler l'exécution d'un **playbook** sans apporter de modifications aux systèmes.

C'est un excellent moyen de tester vos **playbooks** avant de les lancer en production.

```SHELL
ansible-playbook --check playbook.yaml
```

## 1.4. Exemple

Nous allons voir plusieurs exemples dans notre environnement.

**Ping de nos hôtes managed_nodes**

```YAML
- name: Ping les hôtes managed_nodes
  hosts: managed_nodes
  tasks:
    - ping:
```

On exécute :

```SHELL
ansible-playbook playbook.yaml -i inventory/
```
