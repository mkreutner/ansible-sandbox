# 2. Les templates

## 2.1. Les templates

Les **templates** permettent de gérer facilement des configurations dynamiques et complexes. En utilisant le module **template**, vous pouvez créer des fichiers de configuration basés sur des variables définies dans vos **playbooks**, facilitant ainsi le déploiement et la gestion des configurations sur plusieurs serveurs.

Ils utilisent la syntaxe **Jinja2**, un puissant moteur de **templates** pour **Python** dont nous avons déjà parlé à plusieurs reprises, notamment pour les filtres ou l'interpolation de variables.

Les **templates** sont en fait des fichiers texte avec des variables **Jinja2** et des structures de contrôle. Ils finissent par l'extension `.j2` par convention.

Le module **template** va remplacer les variables dans les fichiers **templates** avec les valeurs fournies dans les **playbooks** et les déploie sur les hôtes cibles. Il comprend la syntaxe **Jinja2** utilisée pour insérer des variables et des expressions conditionnelles dans les **templates**.

## 2.2. Les syntaxes utilisables dans les templates

Dans les templates **Ansible** utilisant **Jinja2**, plusieurs syntaxes peuvent être utilisées pour insérer des variables, des conditions, des boucles, et des tests. Voici un résumé des principales fonctionnalités :

### 2.2.1. Variables

Les variables sont insérées avec la syntaxe `{{ variable }}`. 

Par exemple :

```JINJA
server_name {{ server_name }};
```

### 2.2.2. Conditions

Les conditions sont écrites avec `{% if CONDITION %}` et `{% endif %}` (et eventuellement `{% elif CONDITION %}` et  `{% else %}`). Elles permettent de créer des blocs de texte conditionnels.

```JINJA
{% if enable_ssl %}
server {
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/{{ ssl_cert }};
    ssl_certificate_key /etc/ssl/private/{{ ssl_key }};
}
{% endif %}
```

### 2.2.3. Boucles

Les boucles sont écrites avec `{% for item in list %}` et `{% endfor %}`. Elles permettent de répéter des blocs de texte pour chaque élément d'une liste.

```JINJA
upstream backend {
    {% for server in backend_servers %}
    server {{ server }};
    {% endfor %}
}
```

### 2.2.4. Tests
Les tests permettent de vérifier certaines conditions sur les variables. Par exemple, `{% if variable is defined %}` vérifie si une variable est définie.

```JINJA
{% if my_variable is defined %}
    Variable is defined.
{% else %}
    Variable is not defined.
{% endif %}
```

### 2.2.5. Filtres

Les filtres permettent de modifier les variables. Ils sont ajoutés après une variable avec le symbole `|`.

```JINJA
server_name {{ server_name | upper }};
```

### 2.2.6. Inclusion de templates

Vous pouvez inclure un autre template à l'intérieur d'un template avec `{% include 'template.j2' %}`.

```JINJA
{% include 'common_settings.j2' %}
```

## 2.3. Premier exemple avec des variables

Créez un fichier **template** pour la configuration d'un serveur **NGINX**. Par exemple, créez un fichier nommé **nginx.conf.j2** dans le répertoire **templates** :

```JINJA
# templates/nginx.conf.j2

server {
    listen 80;
    server_name {{ server_name }};

    location / {
        proxy_pass http://{{ proxy_pass }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```

`{{ server_name }}` et `{{ proxy_pass }}` sont des variables qui seront remplacées par les valeurs définies dans le playbook.

Créez un **playbook** pour déployer cette configuration sur un serveur **NGINX** :

```YAML
# deploy_nginx.yml

- name: Deploy NGINX configuration
  hosts: webservers
  become: yes

  vars:
    server_name: example.com
    proxy_pass: localhost:3000

  tasks:
    - name: Install NGINX
      ansible.builtin.apt:
        name: nginx
        state: present
        update_cache: yes

    - name: Deploy NGINX configuration file
      ansible.builtin.template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/sites-available/default
        owner: root
        group: root
        mode: '0644'

    - name: Restart NGINX in order to apply changes
      ansible.builtin.service:
        name: nginx
        state: restarted
```

Nous utilisons le module **template** pour copier le fichier template `nginx.conf.j2` vers `/etc/nginx/sites-available/default` sur les hôtes cibles.

Les variables `{{ server_name }}` et `{{ proxy_pass }}` sont remplacées par les valeurs définies dans la section vars du **playbook**.

## 2.4. Exemple plus complexe

Voici un exemple combiné montrant l'utilisation de ces syntaxes dans un template de configuration **NGINX** :

```JINJA
# templates/nginx.conf.j2

{% if enable_ssl %}
server {
    listen 443 ssl;
    ssl_certificate /etc/ssl/certs/{{ ssl_cert }};
    ssl_certificate_key /etc/ssl/private/{{ ssl_key }};
}
{% endif %}

upstream backend {
    {% for server in backend_servers %}
    server {{ server }};
    {% endfor %}
}

server {
    listen 80;
    server_name {{ server_name | default('localhost') }};

    location / {
        proxy_pass http://{{ proxy_pass }};
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}
```