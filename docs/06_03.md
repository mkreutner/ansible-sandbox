# 3. Capturer les sorties des tâches avec register

## 3.1. Création de variables avec register

Lorsque vous exécutez une tâche dans **Ansible**, vous pouvez capturer sa sortie en utilisant le mot-clé **register**.

Cette sortie peut alors être stockée dans une variable que vous nommez. Cette variable contient divers détails sur l'exécution de la tâche, y compris son statut, sortie standard, sortie d'erreur, et code de retour.

```YAML
- name: Register example
  hosts: all
  tasks:
    - name: Get current date and time
      ansible.builtin.command: date
      register: current_date
```

## 3.2. Utilisation des variables créées avec register

La variable enregistrée est un dictionnaire contenant plusieurs informations :

- **stdout** : la sortie standard de la commande.
- **stderr** : la sortie d'erreur de la commande.
- **rc** : le code de retour de la commande.
- **failed** : un booléen qui indique si la tâche a échoué.
- **changed** : un booléen qui indique si la tâche a apporté des modifications.

Vous pouvez accéder à ces informations en utilisant la notation habituelle des dictionnaires en **YAML**, par exemple `ma_var.stdout` ou `ma_var['stdout']`.

```YAML
- name: Register example
  hosts: all
  tasks:
    - name: Get current date and time
      ansible.builtin.command: date
      register: current_date

    - name: Display the date and time
      ansible.builtin.debug:
        msg: "The current date and time is: {{ current_date.stdout }}"
```

Voici un autre exemple :

```YAML
- name: Register output format
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Retrieve the terminal version
      ansible.builtin.shell: bash --version
      register: bash_version

    - name: Show API server response
      ansible.builtin.debug:
        var: bash_version
```

Qui donnera le format de sortie suivant :

```JSON
ok: [localhost] => {
    "bash_version": {
        "changed": true,
        "cmd": "bash --version",
        "delta": "0:00:00.019447",
        "end": "2024-05-06 13:00:57.808825",
        "failed": false,
        "msg": "",
        "rc": 0,
        "start": "2024-05-06 13:00:57.789378",
        "stderr": "",
        "stderr_lines": [],
        "stdout": "GNU bash, version 5.2.21(1)-release (x86_64-pc-linux-gnu)\nCopyright (C) 2022 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\n\nThis is free software; you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.",
        "stdout_lines": [
            "GNU bash, version 5.2.21(1)-release (x86_64-pc-linux-gnu)",
            "Copyright (C) 2022 Free Software Foundation, Inc.",
            "License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>",
            "",
            "This is free software; you are free to change and redistribute it.",
            "There is NO WARRANTY, to the extent permitted by law."
        ]
    }
}
```

Ainsi, pour ne récupérer que la première ligne de la sortie standard qui nous intéresse, nous pourrions faire :

```YAML
- name: Register output format
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Retrieve the terminal version
      ansible.builtin.shell: bash --version
      register: bash_version

    - name: Show API server response
      ansible.builtin.debug:
        var: bash_version.stdout_lines[0]
```
