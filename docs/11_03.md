# 3. Les tags

## 3.1. Les tags

Les **tags** (ou **étiquettes**) permettent de filtrer et d'exécuter des parties spécifiques d'un **playbook**, offrant ainsi un contrôle granulaire sur les tâches à exécuter. 

C'est particulièrement utile lorsque vos **playbooks** commencent à avoir une taille conséquente.

Les **tags** peuvent être appliqués à de nombreuses structures dans **Ansible**, mais leur utilisation la plus fréquente est avec des tâches :

```YAML
tasks:
- name: Install required packages
  ansible.builtin.yum:
    name:
      - nginx
      - memcached
    state: present
  tags:
  - packages

- name: Configure NGINX
  ansible.builtin.copy:
    src: /path/to/nginx.conf
    dest: /etc/nginx/nginx.conf
  tags:
  - configuration
```

### 3.1.1. Exécution des playbooks en utilisant des tags

Pour exécuter uniquement des tâches spécifiques, vous pouvez utiliser l'option `--tags` en ligne de commande :

```SHELL
ansible-playbook my_playbook.yml --tags "configuration,packages"
```

Pour exclure certaines tâches lors de l'exécution, utilisez l'option `--skip-tags` :

```SHELL
ansible-playbook my_playbook.yml --skip-tags "packages"
```

Vous pouvez également voir quelles tâches seront exécutées avec les options `--list-tasks` :

```SHELL
ansible-playbook my_playbook.yml --tags "configuration" --list-tasks
```

### 3.1.2. Réutilisation des tags

Vous pouvez appliquer le même **tag** à plusieurs tâches. Par exemple, pour des tâches liées à la configuration de **NGINX** :

```YAML
- name: Install NGINX
  ansible.builtin.yum:
    name: nginx
    state: present
  tags: nginx_setup

- name: Configure NGINX
  ansible.builtin.copy:
    src: /path/to/nginx.conf
    dest: /etc/nginx/nginx.conf
  tags: nginx_setup

- name: Start NGINX
  ansible.builtin.service:
    name: nginx
    state: started
    enabled: yes
  tags: nginx_setup
```

## 3.2. Héritage des tags

Ajouter des **tags** à un **play** ou à des tâches importées statiquement ajoute ces **tags** à toutes les tâches contenues. C'est ce qu'on appelle l'héritage des **tags**.

```YAML
- hosts: all
  tags:
  - bar
  tasks:
    - name: Task 1
      ansible.builtin.shell: echo "Task 1"

- hosts: all
  tags: [ foo ]
  tasks:
    - name: Task 2
      ansible.builtin.shell: echo "Task 2"
```

Les **tags** peuvent également être appliqués aux rôles et aux tâches et rôles importés :

```YAML
roles:
  - role: webserver
    vars:
      port: 80
    tags: [ web, tag2 ]

- import_role:
    name: monrole
  tags: [ web, tag2 ]

- import_tasks: tache.yml
  tags: [ web, tag2 ]
```


## 3.3. Les tags spéciaux

Il existe des tags spéciaux : **always** et **never** :

- **always** : ces tâches s'exécutent toujours, sauf si spécifiquement ignorées avec `--skip-tags always`.
- **never** : ces tâches ne s'exécutent que si le **tag** est explicitement spécifié.

## 3.4. Exemple

Imaginons un **playbook** pour configurer un serveur web et une base de données avec des tags pour différents environnements (`dev`, `prod`).

```YAML
- hosts: all
  tasks:
    - name: Install required packages
      ansible.builtin.yum:
        name:
          - nginx
          - postgresql
        state: present
      tags:
        - packages

    - name: Configure NGINX for development environment
      ansible.builtin.copy:
        src: /path/to/nginx_dev.conf
        dest: /etc/nginx/nginx.conf
      tags:
        - configuration
        - dev

    - name: Configure NGINX for production environment
      ansible.builtin.copy:
        src: /path/to/nginx_prod.conf
        dest: /etc/nginx/nginx.conf
      tags:
        - configuration
        - prod

    - name: Start NGINX service
      ansible.builtin.service:
        name: nginx
        state: started
      tags:
        - service
```