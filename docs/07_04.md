# 4. Les tests

## 4.1. Les tests

**Les tests**  servent à évaluer des expressions et à retourner `True` ou `False`.

Par exemple, ils permettent de vérifier si une variable est définie, si une chaîne correspond à un motif regex, ou si une valeur est vraie.

Les tests sont particulièrement utiles pour le traitement conditionnel dans les **playbooks**. Vous pouvez les utiliser pour conditionner l'exécution de tâches spécifiques, par exemple, exécuter une tâche seulement si une certaine condition est vraie.

**Les tests s'exécutent toujours sur la node de contrôle Ansible** et **jamais sur les nodes cibles**. Cela signifie que les tests utilisent des données disponibles localement sur la node de contrôle et non sur les données situées sur les hôtes cibles.

Dans les **playbooks** il est possible d'utiliser les tests **Jinja2** + les tests fournis par **Ansible**, comme pour les filtres.

La syntaxe est la suivante :

```JINJA2
variable is test
```

## 4.2. Les tests Jinja2 disponibles

**Jinja2** fournit une variété de tests qui sont utiles pour contrôler la logique des **playbooks**, en particulier dans les directives conditionnelles comme **when**.

### Tests de vérification de types

- **boolean**: Vérifie si une variable est de type booléen.
- **integer**: Vérifie si une variable est un entier.
- **float**: Vérifie si une variable est un nombre à virgule flottante.
- **string**: Vérifie si une variable est une chaîne de caractères.
- **number**: Vérifie si une variable est un nombre (entier ou flottant).
- **sequence**: Vérifie si une variable est une liste ou un tuple.
- **mapping**: Vérifie si une variable est un dictionnaire.
- **iterable**: Vérifie si une variable est itérable (listes, dictionnaires, chaînes, etc.).

### Tests de comparaison

- **eq** (equal to): Vérifie si une variable est égale à une autre.
- **ne** (not equal to): Vérifie si une variable n'est pas égale à une autre.
- **lt** (less than): Vérifie si une variable est inférieure à une autre.
- **le** (less than or equal to): Vérifie si une variable est inférieure ou égale à une autre.
- **gt** (greater than): Vérifie si une variable est supérieure à une autre.
- **ge** (greater than or equal to): Vérifie si une variable est supérieure ou égale à une autre.

### Tests de vérification d'état

- **defined**: Vérifie si une variable est définie.
- **undefined**: Vérifie si une variable n'est pas définie.
- **none**: Vérifie si une variable est None (équivalent de null en Python).
- **true**: Vérifie si une variable est vraie (True).
- **false**: Vérifie si une variable est fausse (False).

### Tests sur le contenu de la variable

- **empty**: Vérifie si une variable est vide (comme une chaîne vide, une liste vide).
- **escaped**: Vérifie si une chaîne de caractères est échappée (utile pour le HTML).
- **callable**: Vérifie si une variable est un appelable (comme une fonction).
- **in**: Vérifie si un élément est présent dans une séquence ou un dictionnaire.

### Tests de manipulation numérique

- **even**: Vérifie si un nombre est pair.
- **odd**: Vérifie si un nombre est impair.
- **divisibleby**: Vérifie si un nombre est divisible par un autre.

### Tests sur les chaînes de caractères

- **lower**: Vérifie si une chaîne est en minuscules.
- **upper**: Vérifie si une chaîne est en majuscules.
- **sameas**: Vérifie si une variable est le même objet que l'autre (identité).

## 4.3. Les tests Ansible

En plus des tests **Jinja2**, il existe des tests supplémentaires fournis par **Ansible** :

### Tests de vérification de conditions

- **all** : Vérifie si toutes les conditions dans une liste sont vraies.
- **any** : Vérifie si au moins une condition dans une liste est vraie.
- **truthy** : Évalue une expression selon les règles de vérité Python (considère des valeurs comme "yes", "on", "1", "true" comme vraies).
- **falsy** : Évalue une expression selon les règles de fausseté Python (considère des valeurs comme "", "no", "off", "0", "false" comme fausses).

### Tests de manipulation de chaînes et regex

- **match, regex** : Vérifie si une chaîne de caractères correspond à une expression régulière dès le début de la chaîne.
- **search** : Vérifie si une chaîne de caractères correspond à une expression régulière à n'importe quel endroit dans la chaîne.
- **uri, url, urn** : Vérifie si la chaîne est une URI, URL ou URN valide respectivement.

### Tests de gestion des chemins et fichiers

- **abs** : Vérifie si un chemin est absolu.
- **exists, link_exists** : Vérifie si un chemin existe, avec ou sans suivre les liens symboliques.
- **file, directory, link** : Vérifie si le chemin est un fichier, un répertoire, ou un lien symbolique existant.
- **same_file** : Compare deux chemins pour voir s'ils résolvent au même objet système de fichiers.
- **mount** : Vérifie si un chemin est un point de montage.

### Tests de gestion des tâches et résultats

- **changed, failed, skipped, unreachable** : Vérifie si la tâche a été modifiée, a échoué, a été ignorée, ou si l'hôte était inaccessible.
- **success** : Vérifie si la tâche s'est terminée avec succès.
- **finished, started** : Vérifie si une tâche asynchrone est terminée ou a commencé.

### Tests de gestion des listes

- **contains** : Vérifie si un élément est présent dans la liste. Utilisable avec **select, reject, selectattr, et rejectattr**.
- **subset, superset** : Vérifie si une liste est un sous-ensemble ou un sur-ensemble d'une autre liste.

### Tests de gestion des données encodées et sécurisées

- **vault_encrypted** : Vérifie si une variable est une valeur chiffrée par Ansible Vault.

### Tests de gestion des versions et formats

- **version** : Compare des chaînes de version en utilisant des opérateurs spécifiques.
- **nan** : Vérifie si une valeur est "Not a Number" (NaN).

## 4.4. Exemples

### Vérifier si une variable est une chaîne non vide

```YAML
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - ansible.builtin.debug:
        msg: "The variable is not empty"
      when: some_variable is string and some_variable | length > 0
      vars:
        some_variable: ""
```

### Tester si un chemin est un répertoire

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - ansible.builtin.debug:
        msg: "The path is a directory"
      when: path_var is directory
      vars:
        path_var: "/etc"
```

### Déterminer si tous les éléments d'une liste sont vrais

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - ansible.builtin.debug:
        msg: "All elements are true"
      when: boolean_list is all
      vars:
        boolean_list: [true, 1 == 1, not false]
```

### Vérifier si une version est supérieure à une autre

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: true
  tasks:
    - ansible.builtin.debug:
        msg: "The version is sufficient"
      when: ansible_facts['distribution_version'] is version('22', '>=')
```

### Tester si une tâche a réussi

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - ansible.builtin.command: echo "Hello World"
      register: result
      changed_when: false
    - ansible.builtin.debug:
        msg: "The task was successful"
      when: result is success
```

### Tester si une liste contient une valeur spécifique

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check the presence of the element
      ansible.builtin.debug:
        msg: "The list contains the searched item"
      when: "'special_item' in item_list"
      vars:
        item_list: ['item1', 'special_item', 'item3']
```

### Comparer des chaînes avec des expressions régulières

```YAML
---
- name: Test sample
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Check a URL
      ansible.builtin.debug:
        msg: "The URL matches the expected pattern"
      when: url_var is search("^http://exemple\\.fr/resource/[0-9]+/?$")
      vars:
        url_var: "http://exemple.fr/resource/12345/"
```
