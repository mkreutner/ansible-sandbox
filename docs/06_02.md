# 2. Les facts personnalisés

## 2.1. Les facts personnalisés

Ajouter des **facts** personnalisés vous permet d'étendre les informations collectées automatiquement par le module **setup** avec des données spécifiques à votre environnement.

### 2.1.1. Ajouter des facts personnalisés

Vous pouvez utiliser le répertoire `/etc/ansible/facts.d` pour y ajouter des scripts exécutables qui retournent des données en format **JSON** ou des fichiers **ini** ou **JSON**.

Il faut que ces scripts soient exécutables (attention aux permissions).

Il faut que les fichiers aient l'extensions `.fact`.

### 2.1.2. Accéder aux facts personnalisés

Ces valeurs sont ensuite accessibles via le **namespace ansible_local**, qui est utilisé pour stocker et organiser les **facts** personnalisés.

Il aide à séparer les **facts** systèmes par défaut et les variables définies ailleurs dans vos **playbooks** des **facts** personnalisés que vous créez.

Pour accéder à ces valeurs dans un **playbook** ou un **template**, vous utilisez la syntaxe suivante :

```YAML
{{ ansible_local['clé1']['cléimbriquée'] }}
```

## 2.2. Exemple d'utilisation

Supposons que vous souhaitiez suivre la version d'une application spécifique installée sur plusieurs serveurs.

Vous pouvez créer un **script** qui détecte cette version et la stocke en tant que **fact** personnalisé.

Créez le **playbook** suivant :

```YAML
- name: Example of a personalized fact
  hosts: all
  become: true

  tasks:
    - name: Node.js installation
      ansible.builtin.apt:
        name: nodejs
        state: present
        update_cache: true

    - name: Ensure facts.d directory exists
      ansible.builtin.file:
        path: /etc/ansible/facts.d
        state: directory
        mode: '0755'

    - name: Deploy custom Node.js version check script
      ansible.builtin.copy:
        dest: /etc/ansible/facts.d/node_version.fact
        mode: '0755'
        content: |
          #!/bin/bash
          echo "{\"node_version\": \"$(node --version)\"}"

    - name: Gather custom facts
      ansible.builtin.setup:

    - name: Check Node.js version
      ansible.builtin.debug:
        msg: "Running with Node.js {{ ansible_local['node_version']['node_version'] }}"
```

Voici son explication :

### 2.2.1. Création du répertoire facts.d

Sur chaque serveur cible, vous devez vous assurer que le répertoire `/etc/ansible/facts.d` existe.

Vous pouvez le faire avec une tâche Ansible :

```YAML
- name: Ensure facts.d directory exists
  ansible.builtin.file:
    path: /etc/ansible/facts.d
    state: directory
    mode: '0755'
```

### 2.2.2. Écriture du script de fact personnalisé

Écrivez un **script** qui extrait la version de l'application et l'imprime en format **JSON**.

Par exemple, supposons que vous voulez capturer la version de **Node.js** installée :

```YAML
- name: Deploy custom Node.js version check script
  ansible.builtin.copy:
    dest: /etc/ansible/facts.d/node_version.fact
    mode: '0755'
    content: |
      #!/bin/bash
      echo "{\"node_version\": \"$(node --version)\"}"
```

- **mode** : définit les permissions du fichier script. `0755` rend le script exécutable.

### 2.2.3. Utilisation des facts dans un playbook

```YAML
- name: Check Node.js version
  ansible.builtin.debug:
    msg: "Running with Node.js {{ ansible_local['node_version']['node_version'] }}"
```

Nous obtiendrons par exemple :

```JSON
ok: [node1] => {
    "msg": "Running with Node.js v20.19.2"
}
ok: [node2] => {
    "msg": "Running with Node.js v20.19.2"
}
```
