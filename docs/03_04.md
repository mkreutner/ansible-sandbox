# 4. Utiliser les motifs

## 4.1. Les patterns Ansible

Les motifs (**patterns**) sont utilisés pour cibler des hôtes et des groupes spécifiques lors de l'exécution de commandes **ad hoc** (avec les différents **CLI**) ou **de playbooks**.

Les motifs sont flexibles et permettent de sélectionner des sous-ensembles d'hôtes, d'utiliser des caractères génériques, des expressions régulières, et plus encore.

## 4.2. Utilisation des motifs

### 4.2.1. Dans une commande ad hoc

```SHELL
ansible <pattern> <module_name> -a "<module_options>"
# or
ansible -m <module_name> -a "<module_options>" <pattern>
```

Par exemple :

```SHELL
ansible managed_nodes -m ping -i inventory/
```

Cette commande utilise le module ping sur tous les hôtes du groupe **managed_nodes**.

### 4.2.2. Dans un playbook

```YAML
- name: <play_name>
  hosts: <pattern>
```

Par exemple :

```YAML
- name: Exemple of pattern in playbook
  hosts: webservers
```

Ce **playbook** exécute le **play** sur tous les hôtes du groupe **webservers**.

## 4.3. Mofits les plus communs

Voici la liste des motifs les plus couramment utilisés, essayez-les tous sur notre environnement d'exemple :

- **Tous les hôtes** : `all` ou `*`
- **Un hôte** : `host1`
- **Plusieurs hôtes** : `host1:host2` ou `host1,host2`
- **Un groupe** : `webservers`
- **Plusieurs groupes** : `webservers:dbservers`
- **Exclure des groupes** : `webservers:!paris`
- **Intersection de groupes** : `webservers:&staging`

Par exemple :

```SHELL
ansible managed-node1,managed-node2 -m ping -i inventory/
```

Dans ce cas on effectue le **ping** sur les hôtes **managed-node1** et **managed-node2**

## 4.4. Combinaisons de motifs

Vous pouvez bien sûr combiner les motifs :

```SHELL
groupe_name:!{{ excluded }}:&{{ required }}
```

## 4.5. Utilisation de la position de group dans les motifs

Vous pouvez utiliser la position des hôtes dans les groupes :

```SHELL
webservers[0]       # First host of the webservers group
webservers[-1]      # Last host in the webservers group
webservers[0:2]     # The first three hosts in the webservers group
```

## 4.6. Utilisation d'expressions régulières dans les motifs

Vous pouvez utiliser des expressions régulières :

```SHELL
hosts: ~(web|db).*\.example\.com
```

## 4.7. Exemples

En utilisant notre environnement précédent avec l'inventaire `inventory/hosts.yaml`, voici quelques exemples d'utilisation des motifs :

- Exécuter une commande **ad hoc** sur tous les serveurs de notre groupe :

```SHELL
ansible managed_nodes -i inventory/hosts.yaml -m ping
```

- Exécuter un **playbook** sur le premier serveur de notre groupe :

```YAML
- name: ping the first containers
  hosts: managed_nodes[0]
  tasks:
    - ping:
```

Puis :

```SHELL
ansible-playbook playbook.yaml -i inventory/
```

- Exclure un groupe spécifique lors de l'exécution d'une commande **ad hoc** :

```SHELL
ansible -i inventory/hosts.yaml all --limit '!web' -m ping
```

Il faut bien sûr déclarer un groupe web dans `hosts.yaml`.

- Utiliser une expression régulière pour cibler des hôtes :

```YAML
- name: Ping hosts whose names begin with managed
  hosts: ~(managed).*
  tasks:
    - ping:
```
