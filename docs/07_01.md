# 1. Le moteur de template Jinja2

## 1.1. Qu'est-ce que Jinja2 ?

**Jinja2** est un moteur de templates pour le langage de programmation **Python**.

Un "template" ou "modèle" est un fichier conçu pour être la base ou le modèle pour des fichiers de sortie, où le modèle contient des variables qui sont remplacées par des valeurs lors de l'exécution du code.

**Jinja2** est particulièrement puissant pour générer des formats de texte, ce qui le rend très utile pour générer des fichiers **HTML**, des fichiers de configuration, ou n'importe quel type de texte structuré basé sur des données dynamiques.

### Caractéristiques de Jinja2 :

- **Héritage de template** : **Jinja2** permet de définir un squelette de base qui peut être étendu ou surchargé par d'autres templates, facilitant ainsi la réutilisation de parties communes dans plusieurs documents.
- **Bloc de texte** : Utilisation de blocs qui peuvent contenir du code logique comme des boucles ou des conditions, permettant une génération de contenu dynamique.
- **Filtres et tests** : Les filtres transforment les données avant de les placer dans le template (par exemple, mise en majuscule, formatage de date), tandis que les tests permettent de vérifier certaines conditions (par exemple, tester si une variable est définie).

## 1.2. Lien entre Ansible et Jinja2

**Ansible** utilise **Jinja2** comme son moteur de templating pour :

- **Templates de fichiers** : **Ansible** permet d'utiliser des **templates Jinja2** pour générer des fichiers de configuration sur les machines gérées. Par exemple, vous pourriez avoir un template pour un fichier de configuration NGINX qui est personnalisé pour chaque machine. _Nous verrons en détail les templates plus tard dans la formation._
- **Variables dynamiques** : Dans les fichiers **YAML** d'**Ansible** (utilisés pour les **playbooks**, les rôles, etc.), on peut utiliser **Jinja2** pour créer des valeurs dynamiques pour les variables. Par exemple, vous pouvez définir une variable qui est le résultat d'une opération ou qui change selon l'environnement d'exécution.
- **Expressions conditionnelles** : **Ansible** permet d'utiliser des expressions **Jinja2** pour exécuter certaines tâches conditionnellement ou pour définir la valeur des variables en fonction des conditions. _Nous les verrons dans ce chapitre_.
- **Filtres** : Les filtres **Jinja2** permettent de manipuler les variables et de traiter les informations de manière dynamique. _Nous les verrons dans ce chapitre_.

Nous allons voir une courte présentation de l'utilisation de **Jinja2** dans les **playbooks**, que nous développerons ensuite dans le chapitre, puis nous étudierons plus tard les **templates**.

### 1.2.1 Variables et expressions

**Jinja2** permet l'interpolation de variables dans des chaînes de caractères, ce qui est fondamental pour réutiliser les données définies dans les variables d'**Ansible**. On utilise les accolades `{{ variable }}` pour évaluer et remplacer la variable par sa valeur.

```YAML
vars:
  username: "admin"
tasks:
  - debug:
      msg: "Welcome Home, {{ username }}!"
```

### 1.2.2. Structures conditionnelles

**Jinja2** permet l'utilisation de structures conditionnelles directement dans les expressions. Cela inclut des tests comme `if`, `else`, et `elif`, permettant de définir des valeurs dynamiques basées sur des conditions.

```YAML
vars:
  score: 85
tasks:
  - debug:
      msg: "{{ 'Pass' if score > 50 else 'Fail' }}"
```

### 1.2.3. Filtres

Les filtres sont des fonctions appliquées aux variables. Ils sont utilisés pour transformer les données, formater des sorties, effectuer des opérations mathématiques, manipuler des listes et des dictionnaires, et plus encore. Voici quelques exemples courants de filtres :

- **map**: Applique une fonction à chaque élément d'une liste.
- **select**: Filtre des éléments d'une liste qui répondent à un critère spécifique.
- **regex_replace**: Applique une expression régulière pour remplacer des parties d'une chaîne.

```YAML
vars:
  numbers: [1, 2, 3, 4, 5]
tasks:
  - debug:
      msg: "{{ numbers | map('pow', 2) | list }}"
```

### 1.2.4. Tests

**Jinja2** inclut une série de "`tests`" qui peuvent être utilisés pour vérifier des conditions spécifiques, comme `defined`, `none`, `equalto`, etc. Ces tests sont particulièrement utiles dans les conditions `when` des tâches **Ansible** pour prendre des décisions basées sur le contenu des variables.

```YAML
tasks:
  - debug:
      msg: "Variable is defined"
    when: variable is defined
```
