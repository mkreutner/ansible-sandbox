# 2. Options de configuration des plays

## 2.1. Les options des plays

Dans un **playbook**, chaque **play** peut être configuré avec plusieurs options pour contrôler la manière dont les tâches sont exécutées sur les hôtes cibles.

### 2.1.1. Gestion des utilisateurs et des privilèges

- **remote_user** : définit l'utilisateur pour la connexion aux hôtes distants.
- **become** : active l'escalade de privilèges.
- **become_method** : spécifie la méthode pour l'escalade de privilèges (e.g., **sudo**, **su**).
- **become_user** : détermine l'utilisateur cible lors de l'escalade de privilèges.
- **become_password** : fournit le mot de passe pour l'escalade de privilèges.

### 2.1.2. Connexion et éxecution

- **connection** : type de la connexion utilisée (**ssh**, **local**, etc.).
- **gather_facts** : contrôle la collecte de faits systèmes au début du **play**.
- **strategy** : définit la stratégie d'exécution des tâches (**linear**, **free**).
- **order** : contrôle l'ordre de traitement des hôtes.

### 2.1.3. Variables et environnement

- **vars** : variables définies pour être accessibles dans le **play**.
- **environment** : variables d'environnement spécifiques appliquées aux tâches.

### 2.1.4. Organisation des tâches

- **tasks** : les tâches principales à exécuter.
- **pre_tasks** : tâches à exécuter avant les tâches principales.
- **post_tasks** : tâches à exécuter après les tâches principales.
- **handlers** : tâches spéciales déclenchées par des notifications d'autres tâches.

### 2.1.5. Filtrage et sélection

- **tags** : tags appliqués aux tâches pour permettre des exécutions sélectives.
- **hosts** : spécifie les hôtes ou les groupes d'hôtes cibles pour le **play**.

Nous verrons au fur à mesure de la formation de nombreux exemples pratiques.

## 2.2. Exemples

### 2.2.1. Connexion `a uen instance EC2 AWS

```YAML
---
- name: Update EC2 servers
  hosts: aws_ec2
  remote_user: ec2-user
  become: true
  become_user: root
  tasks:
    - name: Update all packages
      ansible.builtin.yum:
        name: '*'
        state: latest
```

Il faut se connecter avec l'utilisateur **ec2-user** qui est l'utilisateur pour la connexion **SSH** sur les instances **EC2**, puis escalader les privilèges pour devenir **root** afin de mettre à jour les paquets du système.

### 2.2.2. Configuration de NGINX

```YAML
---
- name: NGINX Basic settings
  hosts: web_servers
  remote_user: ubuntu
  become: true
  tasks:
    - name: NGINX Installation
      ansible.builtin.apt:
        name: nginx
        state: latest

    - name: Update NGINX configuration file
      ansible.builtin.template:
        src: templates/nginx.conf.j2
        dest: /etc/nginx/nginx.conf
      notify: restarting nginx

    - name: Ensure that NGINX is started and activated at boot
      ansible.builtin.service:
        name: nginx
        state: started
        enabled: true

  handlers:
    - name: restarting nginx
      ansible.builtin.service:
        name: nginx
        state: restarted
```

- **hosts**: spécifie le groupe d'hôtes (**web_servers**) sur lesquels le **playbook** doit s'exécuter.
- **remote_user**: identifie l'utilisateur pour la connexion **SSH** aux hôtes distants.
- **become**: active l'escalade de privilèges pour permettre l'exécution de tâches nécessitant des droits administratifs.
- **tasks**:
  - **NGINX Installation**: installe la dernière version de **NGINX** en utilisant le gestionnaire de paquets **apt**.
  - **Update NGINX configuration file**: déploie un fichier de configuration personnalisé à partir d'un template **Jinja2**.
  - **Ensure that NGINX is started and activated at boot**: configure le service **NGINX** pour qu'il démarre lors du démarrage du système et vérifie qu'il est actuellement en cours d'exécution.
- **handlers**: un bloc qui contient des tâches déclenchées en réponse à des notifications d'autres tâches, ici pour redémarrer **NGINX** si la configuration est modifiée.
