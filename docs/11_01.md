# 1. Les rôles

## 1.1. A quoi servent les rôles ?

Les rôles permettent de structurer et d'organiser vos **playbooks** de manière modulaire, facilitant ainsi le **partage** et la **réutilisation** des **tâches**, **variables** et **handlers**.

Un rôle est organisé selon une structure de répertoires spécifique qui permet de regrouper les fichiers de **tâches**, **variables**, **templates**, etc. Le nom des dossiers est donc essentiel.

Les **rôles** ne sont pas utilisables directement, ils sont utilisables dans les **playbooks**.

Les **rôles** sont un sujet avancé pour les projets de grande taille. Vous pouvez cependant utiliser des rôles existants pour vos projets (_cf. partie **Ansible Galaxy**_).

Voici un exemple de structure de répertoire pour un projet **Ansible** utilisant des rôles :

```TEXT
site.yml
webservers.yml
fooservers.yml
roles/
    common/
        tasks/
        handlers/
        files/
        templates/
        vars/
        defaults/
        meta/
    webservers/
        tasks/
        defaults/
        meta/
```

Chaque répertoire doit contenir un fichier **main.yml**, qui contient le contenu pertinent :

- **tasks** : contient la liste principale des tâches à exécuter par le rôle.
- **handlers** : contient les handlers, qui peuvent être utilisés par ce rôle ou en dehors de ce rôle.
- **defaults** : variables par défaut pour le rôle.
- **vars** : autres variables pour le rôle.
- **files** : contient des fichiers qui peuvent être déployés via ce rôle.
- **templates** : contient des **templates** qui peuvent être déployés via ce rôle.
- **meta** : définit des métadonnées pour ce rôle, telles que les dépendances de rôle.

_Nous verrons les **handlers** et les **templates** dans le chapitre suivant._

Vous pouvez créer un nouveau rôle avec la commande :

```SHELL
ansible-galaxy init [ROLE_NAME]
```

## 1.2. Les rôles et Ansible Galaxy

Comme nous l'avons déjà vu, **Ansible Galaxy** est une [plateforme communautaire](https://galaxy.ansible.com/) et un outil inclus avec **Ansible** qui permet de découvrir, partager, et réutiliser des rôles et des collections **Ansible** créés par d'autres utilisateurs.

Les utilisateurs peuvent rechercher des rôles qui répondent à leurs besoins (par exemple, des rôles pour configurer des serveurs web, des bases de données, des systèmes de surveillance, etc.).

L'outil en ligne de commande **ansible-galaxy** permet notamment d'installer un rôle disponible sur Galaxy avec :

```SHELL
ansible-galaxy install [ROLE_NAME]
```

Allez voir les rôles les plus téléchargés [ici](https://galaxy.ansible.com/ui/standalone/roles/?page=1&page_size=10&sort=-download_count). 

Etudiez par exemple le [contenu de ce rôle populaire](https://github.com/geerlingguy/ansible-role-nginx/tree/master).

## 1.3. Utilisation des rôles

Pour un **play** donné, on va utiliser la clé **roles** et spécifier les rôles utilisés pour le **play** :

```YAML
---
- hosts: webservers
  roles:
    - common
    - webservers
```

Pour chaque rôle x :

- Si `roles/x/tasks/main.yml` existe, les **tâches** listées y seront ajoutées au **play**.
- Si `roles/x/handlers/main.yml` existe, les **handlers** y seront ajoutés au **play**.
- Si `roles/x/vars/main.yml` existe, les **variables** y seront ajoutées au **play**.
- Si `roles/x/defaults/main.yml` existe, les **variables** y seront ajoutées au **play**.
- Si `roles/x/meta/main.yml` existe, les **dépendances** de rôle y seront ajoutées à la liste des **rôles**.

L'ordre d'exécution pour votre **playbook** est le suivant :

- Les **pre_tasks** définies dans le **play**.
- Les **handlers** déclenchés jusqu'à présent seront exécutés.
- Chaque rôle listé dans **roles** sera exécuté à son tour.
- Les tâches définies dans le **play**.
- Les **handlers** déclenchés jusqu'à présent seront exécutés.
- Les **post_tasks** définies dans le **play**.
- Les **handlers** déclenchés jusqu'à présent seront exécutés.

## 1.4. Dépendances de rôles

Les dépendances de rôles permettent de charger automatiquement d'autres rôles lorsqu'un rôle est utilisé. Les dépendances sont définies dans le fichier `meta/main.yml` du rôle.

```YAML
# roles/myapp/meta/main.yml
---
dependencies:
  - role: common
    vars:
      une_var: 1
  - role: nginx
    vars:
      nginx_port: 80
  - role: postgres
    vars:
      dbname: blarg
      autre_var: 42
```

## 1.5. Exemple d'utilisation de rôles

Structure des répertoires

```TEXT
roles/
    common/
        tasks/
            main.yml
        handlers/
            main.yml
        files/
        templates/
        vars/
            main.yml
        defaults/
            main.yml
        meta/
            main.yml
    webserver/
        tasks/
            main.yml
        handlers/
            main.yml
        files/
        templates/
        vars/
            main.yml
        defaults/
            main.yml
        meta/
            main.yml
    database/
        tasks/
            main.yml
        handlers/
            main.yml
        files/
        templates/
        vars/
            main.yml
        defaults/
            main.yml
        meta/
            main.yml
```

Nous allons prendre quelques exemples de ce à quoi pourrait ressembler les fichiers.

#### roles/common/tasks/main.yml

```YAML
- name: Update APT packages cache
  ansible.builtin.apt:
    update_cache: yes

- name: Install common tools
  ansible.builtin.apt:
    name:
      - curl
      - vim
    state: present
```


#### roles/webserver/tasks/main.yml

```YAML
- name: Install NGINX
  ansible.builtin.apt:
    name: nginx
    state: present

- name: Start NGINX service
  ansible.builtin.service:
    name: nginx
    state: started

```

#### roles/database/tasks/main.yml

```YAML
- name: Install PostgreSQL
  ansible.builtin.apt:
    name: postgresql
    state: present

- name: Start PostgreSQL service
  ansible.builtin.service:
    name: postgresql
    state: started
```

#### Playbook

```YAML
---
- hosts: all
  roles:
    - common

- hosts: webservers
  roles:
    - webserver

- hosts: dbservers
  roles:
    - database
```

Chaque groupe exécute un rôle qui lui est défini.