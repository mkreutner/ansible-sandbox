# 2. Les boucles avec with\_\<lookup\>

## 2.1. Les boucles with\_\<lookup\>

Les boucles **with\_\<lookup\>** permettent d'itérer sur des collections d'éléments en utilisant différents plugins de recherche (**lookup**).

Chaque fois que vous voyez **with\_\<lookup\>**, la partie après le souligné est le nom d'un plugin de recherche.

Ces boucles sont utilisées pour exécuter une tâche plusieurs fois, une fois pour chaque élément de la collection fournie par le plugin de recherche.

_Ansible a introduit le mot-clé loop dans la version 2.5 comme une méthode plus moderne et flexible pour gérer les itérations dans les playbooks. Nous le verrons dans la leçon suivant et il doit être privilégié dans la grande majorité des cas. Nous voyons quand même with\_\<lookup\> car vous pouvez le retrouver fréquemment._

## 2.2. Fonctionnement des boucles with\_\<lookup\>

Les boucles **with\_\<lookup\>** combinent la puissance des plugins de recherche avec la flexibilité des boucles pour permettre l'itération sur des collections complexes. 

Voici comment les utiliser :

1. Définir une collection d'éléments à itérer.
2. Spécifier le plugin de recherche (**lookup**) à utiliser.
3. Passer les éléments de la collection à la tâche en utilisant **item** pour représenter chaque élément.

La syntaxe de base est ainsi la suivante :

```YAML
tasks:
  - name: Example of a with_items loop
    ansible.builtin.debug:
      msg: "{{ item }}"
    with_items:
      - "First element"
      - "Second element"
      - "Third element"
```

Dans cet exemple, la tâche **debug** sera exécutée trois fois, une fois pour chaque élément de la liste passée à **with\_items**.

## 2.3. Exemples de plugins de recherche courant

### with\_items

Il est utilisé pour itérer sur une liste d'éléments.

```YAML
tasks:
  - name: Add multiple users
    ansible.builtin.user:
      name: "{{ item }}"
      state: present
      groups: "staff"
    with_items:
      - "user1"
      - "user2"
```

### with\_fileglob

Il permet de lister les fichiers correspondant à un motif.

```YAML
tasks:
  - name: List .txt files in the directory
    ansible.builtin.debug:
      msg: "{{ item }}"
    with_fileglob:
      - "/path/to/files/*.txt"
```

### with\_dict

Il itère sur les paires clé/valeur d'un dictionnaire.

```YAML
vars:
  users:
    user1: "admin"
    user2: "user"

tasks:
  - name: View users and their roles
    ansible.builtin.debug:
      msg: "User: {{ item.key }}, Role: {{ item.value }}"
    with_dict: "{{ users }}"
```

### with\_sequence

Il génère une séquence de nombres.

```YAML
tasks:
  - name: Generate a sequence of numbers
    ansible.builtin.debug:
      msg: "{{ item }}"
    with_sequence: "start=1 end=5"
```

### with\_nested

Il itère sur des combinaisons de listes imbriquées (produit cartésien).

```YAML
tasks:
  - name: Combining nested lists
    ansible.builtin.debug:
      msg: "User: {{ item.0 }}, Database: {{ item.1 }}"
    with_nested:
      - ["alice", "bob"]
      - ["clientdb", "employeedb"]
```

### with\_random\_choice

**with\_random\_choice** est utilisé pour sélectionner un élément aléatoire dans une liste. C'est utile pour des scénarios où vous avez besoin de sélection aléatoire.

```YAML
- name: Assign a task to a random server
  hosts: localhost
  tasks:
    - name: Define the server list
      set_fact:
        servers:
          - server1
          - server2
          - server3

    - name: Select a random server
      ansible.builtin.debug:
        msg: "The task will be assigned to : {{ item }}"
      with_random_choice: "{{ servers }}"
```