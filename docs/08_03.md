# 3. Les boucles avec loop

## 3.1. Les boucles avec loop

Le mot-clé **loop** a été introduit dans **Ansible 2.5** pour simplifier et uniformiser la manière d'exécuter des tâches multiples fois.

Le mot-clé **loop** est équivalent à **with_list** et est le meilleur choix pour les boucles simples.

Bien qu'il ne remplace pas encore entièrement les boucles **with\_\<lookup\>**, il est recommandé pour la plupart des cas d'utilisation.

## 3.2. Syntaxe de base

Voici un exemple simple utilisant **loop** :

```YAML
- name: Add multiple users
  ansible.builtin.user:
    name: "{{ item }}"
    state: present
    groups: "wheel"
  loop:
    - john
    - donald
```

Vous pouvez également définir la liste dans un fichier de variables ou dans la section **vars** de votre **playbook**.

```YAML
vars:
  user_list:
    - john
    - donald

tasks:
  - name: Add multiple users
    ansible.builtin.user:
      name: "{{ item }}"
      state: present
      groups: "wheel"
    loop: "{{ user_list }}"
```

Vous pouvez utiliser des dictionnaires dans les listes :

```YAML
- name: Add multiple users
  ansible.builtin.user:
    name: "{{ item.name }}"
    state: present
    groups: "{{ item.groups }}"
  loop:
    - { name: 'john', groups: 'sudo' }
    - { name: 'donald', groups: 'root' }
```

## 3.3. Les variables étendues

Introduites dans la version **2.8 d'Ansible**, les variables étendues de boucle fournissent des informations détaillées sur l'état de la boucle lors de l'itération.

L'option **extended** de **loop_control** permet d'accéder à ces variables, offrant ainsi une plus grande flexibilité et un meilleur contrôle lors de l'exécution des boucles.

Voici les variables étendues disponibles et leurs descriptions :

- **ansible_loop.allitems** : La liste de tous les éléments de la boucle.
- **ansible_loop.index** : L'itération actuelle de la boucle (indexée à partir de 1).
- **ansible_loop.index0** : L'itération actuelle de la boucle (indexée à partir de 0).
- **ansible_loop.revindex** : Le nombre d'itérations depuis la fin de la boucle (indexé à partir de 1).
- **ansible_loop.revindex0** : Le nombre d'itérations depuis la fin de la boucle (indexé à partir de 0).
- **ansible_loop.first** : Vrai si c'est la première itération.
- **ansible_loop.last** : Vrai si c'est la dernière itération.
- **ansible_loop.length** : Le nombre d'éléments dans la boucle.
- **ansible_loop.previtem** : L'élément de l'itération précédente de la boucle. Indéfini lors de la première itération.
- **ansible_loop.nextitem** : L'élément de l'itération suivante de la boucle. Indéfini lors de la dernière itération.

Par exemple :

```YAML
- name: Show loop information
  hosts: localhost
  tasks:
    - name: Loop over a list of items with extended information
      ansible.builtin.debug:
        msg: >
          Current index: {{ ansible_loop.index }}
          Current item: {{ item }}
          First element: {{ ansible_loop.first }}
          Last element: {{ ansible_loop.last }}
          Previous: {{ ansible_loop.previtem | default('N/A') }}
          Next: {{ ansible_loop.nextitem | default('N/A') }}
      loop:
        - "Elem-01"
        - "Elem-02"
        - "Elem-03"
      loop_control:
        extended: true
```

## 3.4. Exemples courants d'utilisation

### Afficher tous les hôtes de l'inventaire

```YAML
- name: Show all hosts in inventory
  ansible.builtin.debug:
    msg: "{{ item }}"
  loop: "{{ groups['all'] }}"
```

Créer des serveurs avec une pause entre chaque

```YAML
- name: Create servers, pause for 3s before creating the next one
  community.digitalocean.digital_ocean:
    name: "{{ item }}"
    state: present
  loop:
    - server-01
    - server-02
  loop_control:
    pause: 3
```

### Installation de paquets

```YAML
- name: Install packages
  hosts: localhost
  tasks:
    - name: Install packages with loop
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      loop:
        - httpd
        - mariadb
        - php
```

### Création de répertoires

```YAML
- name: Create directories
  hosts: localhost
  tasks:
    - name: Create directories with loop
      ansible.builtin.file:
        path: "/tmp/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - dir1
        - dir2
        - dir3
```