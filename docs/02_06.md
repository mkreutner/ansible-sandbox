# 6. Les variables d'inventaire

## 6.1. Que sont les variables ?

Les variables peuvent être définies pour des hôtes spécifiques ou des groupes entiers, et peuvent être organisées de différentes manières pour une gestion plus efficace.

### 6.1.1. Ajout de variables à l'inventaire

Vous pouvez ajouter des variables directement dans le fichier d'inventaire principal pour chaque hôte ou groupe en procédant de cette manière :

```YAML
paris:
  hosts:
    host1:
      http_port: 80
      maxRequestsPerChild: 808
    host2:
      http_port: 303
      maxRequestsPerChild: 909
```

### 6.1.2. Variables pour plusieurs hôtes : les variables de groupe

Vous pouvez assigner une variable à tous les hôtes d'un groupe.

```YAML
paris:
  vars:
    email_server: email.paris.example.com
```

### 6.1.3. Héritage de variables: variables de groupe pour des groupes de groupes

Vous pouvez appliquer des variables à des groupes parents ainsi qu'à des groupes enfants.

```YAML
france:
  children:
    paris:
    lyon:
  vars:
    email_server: email.france.example.com
```

### 6.1.4. Syntaxe de la définition des variables

Vous pouvez définir simplement un nom et une valeur :

```YAML
key: value
```

#### Listes

Les variables de liste contiennent plusieurs valeurs. Vous pouvez définir une liste avec la syntaxe **YAML** suivante :

```YAML
regions:
  - northeast
  - southeast
  - midwest
```

Pour lire les variables qui contiennent des listes vous pouvez faire :

```YAML
- ansible.builtin.debug:
    msg: "The first region is {{ regions[0] }}"
```

#### Dictionnaires

Les dictionnaires stockent les données sous forme de paires **clé-valeur**.

```YAML
database:
  host: dbserver
  port: 5432
```

Pour accéder à une clé :

```YAML
- ansible.builtin.debug:
    msg: "Database port is {{ database['port'] }}"
```

## 6.2. Portée des variables

### 6.2.1. Les variables globales

Les variables globales sont configurées à travers les fichiers de configuration d'**Ansible**, les variables d'environnement, ou directement via la ligne de commande lors de l'exécution d'un **playbook**.

Ces variables sont accessibles depuis n'importe quel endroit dans vos **playbooks**. Elles sont utiles pour définir des configurations qui doivent être cohérentes à travers tous les hôtes et toutes les tâches, comme les paramètres de connexion ou les chemins de répertoires de base.

Vous pouvez par exemple créer un fichier `group_vars/all.yml` :

```YAML
# group_vars/all.yml
api_server: "https://restapi.fr"
```

Ce fichier contient des variables qui sont automatiquement appliquées à tous les hôtes de votre inventaire, rendant **api_server** disponible globalement.

```YAML
- name: Access the global API server configuration
  hosts: localhost
  gather_facts: false

  tasks:
    - name: Show API server address
      ansible.builtin.debug:
        msg: "The API server address is {{ api_server }}"

    - name: Use the API server in a task
      uri:
        url: "{{ api_server }}/api/recipes"
        method: GET
        return_content: yes
      register: reponse

    - name: Show API server response
      ansible.builtin.debug:
        msg: "The API server responded with : {{ reponse.content }}"
```

Cet exemple est testable sur l'**API Dyma**, **restapi.fr**.

Vous pouvez définir des variables non seulement pour tous les hôtes via **group_vars/all**, mais également pour des groupes spécifiques en utilisant des dossiers et fichiers dédiés sous **group_vars**.

Par exemple, pour restreindre ces variables globales au groupe **webservers** :

```YAML
# group_vars/webservers.yml
http_port: 80
max_clients: 200
```

Vous pouvez également définir des variables directement en ligne de commande lors du lancement d'un **playbook**, ce qui est utile pour passer des valeurs dynamiques ou des secrets sans les écrire dans un fichier.

```SHELL
ansible-playbook ansible/playbook.yml -e "api_key=ED157FF4747 secret_key=s!3c!r3!t##2025"
```

### 6.2.2. Au niveau du play

Les variables sont définies dans la section **vars** du **play**.

Les variables définies dans un **play** sont locales à ce **play** (leur portée est restreinte). Cela signifie qu'elles ne sont accessibles que pour les tâches exécutées dans le cadre de ce **play**. Elles ne sont pas disponibles pour d'autres **plays** dans le même **playbook**, ce qui aide à isoler les configurations et à réduire les risques de conflits entre variables.

À l'intérieur du **play**, ces variables peuvent être utilisées par toutes les tâches.

Par exemple, si vous définissez une variable **http_port**, vous pouvez l'utiliser dans n'importe quelle tâche de ce **play** pour configurer un serveur web, ouvrir un port spécifique dans les règles de pare-feu, etc.

```YAML
- hosts: webservers
  vars:
    http_port: 80

  tasks:
    - name: Configure http port for web server
      ansible.builtin.template:
        src: templates/httpd.conf.j2
        dest: /etc/httpd/conf/httpd.conf
        mode: '0644'

    - name: Open HTTP port in firewall
      ansible.builtin.firewalld:
        port: "{{ http_port }}/tcp"
        permanent: true
        state: enabled
```

Dans un **playbook**, vous pouvez inclure des fichiers de variables externe pour structurer votre gestion des variables avec **vars_files**.

```YAML
- hosts: all
  vars_files:
    - secrets.yml
    - more_vars.yml
  tasks:
    - debug:
        msg: "The secret is {{ secret_key }}"
```

### 6.2.3. Les variables d'hôte

Les variables d'hôte sont des variables spécifiques à un hôte individuel, utilisées pour gérer les configurations et les comportements qui varient d'un hôte à l'autre. Elles sont particulièrement utiles pour définir des paramètres uniques à chaque machine ou serveur dans votre infrastructure.

Les variables d'hôte ont une portée limitée à l'hôte pour lequel elles sont définies. Cela signifie que chaque hôte peut avoir ses propres valeurs spécifiques pour des variables qui ne sont pas partagées avec d'autres hôtes, même s'ils sont dans le même groupe ou exécutent le même **playbook**.

Vous pouvez créer un fichier sous le répertoire **host_vars** portant le nom de l'hôte. Les variables définies dans ce fichier seront appliquées uniquement à cet hôte spécifique.

```TEXT
├── host_vars
│   ├── hostname1.yml
│   └── hostname2.yml
```

Avec par exemple dans `host_vars/hostname1.yml` :

```YAML
ansible_user: admin
ansible_ssh_private_key_file: /path/to/private/key
```

Vous pouvez définir des variables d'hôte directement dans votre fichier d'inventaire (sous forme **INI** ou **YAML**).

```YAML
all:
  hosts:
    hostname1:
      http_port: 80
      max_clients: 100
    hostname2:
      http_port: 8080
      max_clients: 150
```

Les variables d'hôte peuvent être passées à **Ansible** en ligne de commande avec l'option **-e (--extra-vars)** lors de l'exécution d'un **playbook**.

## 6.3. Organisation des variables

Il est recommandé de stocker les variables d'hôte et de groupe dans des fichiers séparés pour une meilleure organisation.

Avec **Ansible** le nom des dossier est important car **Ansible** va rechercher les dossiers avec des noms spécifiques.

**Ansible** va automatiquement détecter les répertoires **group_vars** et **host_vars** aussi leur nom et leur emplacement sont importants.

```TEXT
├── /path/to/ansible/inventory/
│   ├── group_vars/
│   │   ├── paris.yaml
│   ├── host_vars/
│   │   ├── host1.yaml
```

Pour **ansible-playbook**, vous devez ajouter les répertoires **group_vars/** et **host_vars/** à votre répertoire **playbook**.

Les autres commandes **Ansible** (par exemple, **ansible**, **ansible-console**, etc.) ne chercheront que **group_vars/** et **host_vars/** dans le répertoire **inventory**.

Si vous souhaitez que d'autres commandes chargent les variables de groupe et d'hôte à partir d'un répertoire **playbook**, vous devez fournir l'option **--playbook-dir** sur la ligne de commande.

Si vous chargez des fichiers d'inventaire à partir du répertoire **playbook** et du répertoire **inventory**, les variables du répertoire **playbook** auront la priorité sur les variables définies dans le répertoire **inventory**.

## 6.4. Exemple sur nos containers pour les groupes et les variables

Voici un petit exemple que vous pouvez tester avec notre configuration de quatre containers.

### 6.4.1. Création ou modification de l'inventaire

Si vous ne l'avez pas déjà fait, créez un fichier nommé **inventory.yaml** dans le container **ansible** à ce chemin `~/workspace/ansible/inventory.yaml` :

```YAML
all:
 children:
   managed_nodes:
     hosts:
       managed-node1:
         ansible_host: 172.16.128.11
         ansible_user: sysadm
         ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
       managed-node2:
         ansible_host: 172.16.128.12
         ansible_user: sysadm
         ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
       managed-node3:
         ansible_host: 172.16.128.13
         ansible_user: sysadm
         ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
     vars:
       example_variable: "I am a group varaible"
```

Dans cet inventaire, nous avons défini un groupe **managed_nodes** qui contient nos trois noeuds gérés.

Pour chaque noeud, nous spécifions l'adresse **IP**, l'utilisateur et le chemin d'accès à la clé privée **SSH** pour la connexion. Nous avons également défini une variable de groupe **example_variable**.

### 6.4.2. Création ou modification du playbook

Si vous ne l'avez pas déjà fait, créez un fichier nommé **playbook.yaml** dans le container **ansible** à ce chemin `~/workspace/ansible/playbook.yaml` :

```YAML
- name: Playbook example
  hosts: managed_nodes
  tasks:
    - name: Display group variable
      debug:
        msg: "The group variable is: {{ example_variable }}"
```

_Nous verrons bien sûr les **playbooks** en détail dans un chapitre dédié_.

Ce **playbook** contient une seule tâche qui affiche la valeur de la variable de groupe **example_variable**.

Toujours dans le conatiner **ansible** :

```SHELL
ansible-playbook -i ansible/inventory.yaml ansible/playbook.yaml
```

## 6.5. Exemple plus complexe

Pour complexifier l'exemple et mieux comprendre tout ce que nous avons vu jusqu'à maintenant, nous allons structurer les fichiers et dossiers selon l'architecture recommandée pour un projet **Ansible** et utiliser plusieurs variables d'hôtes et de **groupes**.

Créez cette structure toujours sus le container **ansible** :

```TEXT
ansible/
├── group_vars/
│   ├── all.yaml
│   └── managed_nodes.yaml
├── host_vars/
│   ├── managed-node1.yaml
│   └── managed-node2.yaml
│   └── managed-node3.yaml
├── inventory/
│   └── hosts.yaml
└── playbook.yaml
```

### 6.5.1. Définition de l'inventaire (inventory/hosts.yaml)

L'inventaire ne change pas sauf que nous ne mettons pas de variable ici, comme recommandé :

```YAML
all:
  children:
  managed_nodes:
    hosts:
      managed-node1:
        ansible_host: 172.16.128.11
        ansible_user: sysadm
        ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
      managed-node2:
        ansible_host: 172.16.128.12
        ansible_user: sysadm
        ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
      managed-node3:
        ansible_host: 172.16.128.13
        ansible_user: sysadm
        ansible_ssh_private_key_file: ~/.ssh/ssh_key_developer
```

### 6.5.2. Définition des variables de groupe

`group_vars/all.yaml` :

```YAML
common_variable: "I am a common variable for all hosts"
```

`group_vars/managed_nodes.yaml` :

```YAML
group_variable: "I am a variable of the managed_nodes group"
```

### 6.5.3. Définition des variables d'hôte

`host_vars/managed-node1.yaml` :

```YAML
host_variable: "I am a variable specific to managed-node1"
```

`host_vars/managed-node2.yaml` :

```YAML
host_variable: "I am a variable specific to managed-node2"
```

`host_vars/managed-node3.yaml` :

```YAML
host_variable: "I am a variable specific to managed-node3"
```

### 6.5.4. Création du playbook (ansible/playbook.yaml)

```YAML
- name: Playbook example
  hosts: managed_nodes
  tasks:
    - name: Display variables
      debug:
        msg: |
          Common variable: {{ common_variable }}
          Group variable: {{ group_variable }}
          Host variable: {{ host_variable }}
```

Exécutez :

```SHELL
ansible-playbook -i inventory/hosts.yaml playbook.yaml
```
