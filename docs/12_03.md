# 3. Les hanglers

## 3.1. Que sont les handlers ?

Les **handlers** (gestionnaires) sont des tâches spécifiques qui ne s'exécutent que lorsqu'elles sont déclenchées par d'autres tâches.

Ils sont souvent utilisés pour exécuter des actions conditionnelles, comme le redémarrage d'un service après qu'un fichier de configuration ait été modifié.

Les **handlers** garantissent que certaines opérations ne sont effectuées qu'une fois, même si elles sont déclenchées plusieurs fois par différentes tâches.

## 3.2. Déclaration des handlers

Les **handlers** sont déclarés dans une section spéciale **handlers**.

Cette section peut être incluse dans le même **playbook** que les tâches ou dans un fichier séparé.

```YAML
---
- name: Web server configuration
  hosts: webservers
  become: yes

  tasks:
    - name: Copy NGINX configuration file
      ansible.builtin.copy:
        src: /path/to/nginx.conf
        dest: /etc/nginx/nginx.conf
      notify:
        - Restart NGINX

  handlers:
    - name: Restart NGINX
      ansible.builtin.service:
        name: nginx
        state: restarted
```

Dans cet exemple, le fichier de configuration de **NGINX** est copié et si la copie entraîne un changement, le **handler Restart NGINX** est appelé. 

S'il n'y a pas de changement, le service n'est pas redémarré.

## 3.3. Déclenchement des handlers

Un **handler** est déclenché par l'instruction **notify** dans une tâche.

Si la tâche change quelque chose (par exemple, si elle modifie un fichier), le **handler** spécifié est ajouté à une liste de tâches à exécuter à la fin du bloc de tâches courant.

Par défaut, les **handlers** s'exécutent après l'exécution de toutes les tâches d'un play.

Cette approche est efficace car le **handler** ne s'exécute qu'une fois, quel que soit le nombre de fois où il a été notifié. Par exemple, si plusieurs tâches mettent à jour un fichier de configuration et notifient un **handler** pour redémarrer **NGINX**, **Ansible** ne redémarre **NGINX** qu'une seule fois pour éviter des redémarrages inutiles.

Voici un exemple avec plusieurs **handlers** :

```YAML
---
- name: Web servers configuration
  hosts: all
  become: yes

  tasks:
    - name: Copy NGINX configuration file
      ansible.builtin.copy:
        src: /path/to/nginx.conf
        dest: /etc/nginx/nginx.conf
      notify:
        - Restart NGINX

    - name: Copy PHP configuration file
      ansible.builtin.copy:
        src: /path/to/php.ini
        dest: /etc/php.ini
      notify:
        - Restart PHP-FPM

  handlers:
    - name: Restart NGINX
      ansible.builtin.service:
        name: nginx
        state: restarted

    - name: Restart PHP-FPM
      ansible.builtin.service:
        name: php-fpm
        state: restarted
```

## 3.4. Forcer l'exécution des handlers

Si vous avez besoin que les **handlers** s'exécutent avant la fin du **play**, vous pouvez ajouter une tâche pour les forcer à s'exécuter en utilisant le module **meta**, qui exécute les actions d'**Ansible** :

```YAML
tasks:
  - name: Somes tasks
    ansible.builtin.shell: ...

  - name: Execute handlers
    meta: flush_handlers

  - name: Another tasks
    ansible.builtin.shell: ...
```

La tâche `meta: flush_handlers` déclenche tous les **handlers** qui ont été notifiés à ce moment du **play**.

## 3.5. Définir les changements de tâche

Vous pouvez contrôler quand les **handlers** sont notifiés en définissant les changements de tâche en utilisant le mot-clé **changed_when**.

Dans l'exemple suivant, le **handler** redémarre le service chaque fois que le fichier de configuration est copié :

```YAML
tasks:
  - name: Copy NGINX configuration file
    ansible.builtin.copy:
      src: /path/to/nginx.conf
      dest: /etc/nginx/nginx.conf
    changed_when: True
    notify: Restart NGINX
```

