# 3. Le CLI ansible-playbook

## 3.1. Le CLI ansible-playbook

**ansible-playbook** est l'outil de ligne de commande pour exécuter les **playbooks** **Ansible**.

Nous l'avons déjà un peu vu mais allons voir toutes les options principales qui vous serviront régulièrement.

Il offre de nombreuses options pour personnaliser l'exécution des **playbooks**.

## 3.1. Options principales de ansicle-playbook

### 3.1.1. Options de base

- **-i**, **--inventory** : spécifie le fichier d'inventaire ou la liste d'hôtes. Cela permet à Ansible de savoir sur quels hôtes exécuter les tâches.
- **-l**, **--limit** : permet de limiter les hôtes ciblés à un sous-ensemble spécifique, ce qui est utile pour exécuter un **playbook** sur un groupe restreint d'hôtes.
- **-t**, **--tags** : exécute uniquement les tâches marquées avec les tags spécifiés, permettant de filtrer quelles parties du **playbook** sont exécutées.
- **--skip-tags** : ignore les tâches qui ont certains tags, ce qui est l'inverse de l'option **-t**.
- **-C**, **--check** : exécute le **playbook** en mode vérification, ce qui permet de prévoir les changements sans les appliquer réellement.
- **-D**, **--diff** : montre les différences générées par les tâches; très utile avec l'option **--check**.

### 3.1.2. Gestion des privilèges

- **-b**, **--become** : utilise l'escalade de privilèges (par défaut avec **sudo**) pour exécuter des tâches qui nécessitent des droits supérieurs.
- **--become-method** : spécifie la méthode d'escalade de privilèges (par défaut **sudo**).
- **--become-user** : définit l'utilisateur sous lequel exécuter les tâches (par défaut **root**).
- **-K**, **--ask-become-pass** : demande le mot de passe pour l'escalade de privilèges.

### 3.1.3. Gestion de l'exécution

- **--start-at-task** : commence l'exécution du **playbook** à la tâche spécifiée, utile pour reprendre une exécution interrompue.
- **--step** : exécute le **playbook** pas à pas, demandant une confirmation avant chaque tâche, ce qui est pratique pour le débogage.
- **--list-tasks** : liste toutes les tâches du **playbook** sans les exécuter, fournissant un aperçu des actions planifiées.

### 3.1.4. Options de connexion

- **-u**, **--user** : définit l'utilisateur à utiliser pour la connexion aux hôtes.
- **-k**, **--ask-pass** : demande le mot de passe **SSH** pour la connexion aux hôtes.
- **--private-key** : spécifie le fichier de clé privée à utiliser pour la connexion **SSH**.
- **-c**, **--connection** : définit le type de connexion (par exemple **ssh**, **local**).

### 3.1.5. Variables et inventaires dynamiques

- **-e**, **--extra-vars** : permet de passer des variables supplémentaires au **playbook** au format clé=valeur ou en utilisant un fichier **JSON/YAML**.

### 3.1.6. Autre options utiles

- **-v**, **--verbose** : augmente la verbosité des messages de débogage. Plus vous ajoutez de **v** (jusqu'à **-vvvvvv**), plus la sortie est détaillée.

* **--syntax-check** : vérifie la syntaxe du **playbook** sans l'exécuter, permettant de détecter les erreurs avant une exécution complète.

## 3.2. Exemple

Nous allons prendre un exemple de **playbook** :

```YAML
---
- name: Setting up Nginx on web servers
  hosts: webservers
  become: true
  tasks:
    - name: Install Nginx
      ansible.builtin.yum:
        name: nginx
        state: present
      tags: [installation, nginx]

    - name: Copy configuration file of Nginx
      ansible.builtin.copy:
        src: confs/nginx.conf
        dest: /etc/nginx/nginx.conf
      tags: [configuration, nginx]

- name: Update database servers
  hosts: databases
  become: true
  tasks:
    - name: Update all packages
      ansible.builtin.yum:
        name: "*"
        state: latest
      tags: [update, database]
```

Ne vous souciez pas trop des paramètres des modules que nous verrons plus tard.

Maintenant, exécutons ce **playbook** en limitant l'exécution à des hôtes spécifiques, en utilisant des **tags** pour sélectionner des tâches spécifiques, et en définissant un niveau de verbosité plus élevé :

```SHELL
ansible-playbook exemple_playbook_nginx.yml -i inventory.ini -l 'webservers:&newyork' -t update -v
```

- `-i inventory.ini` : définit le fichier d'inventaire à utiliser pour déterminer les hôtes disponibles.
- `-l 'webservers:&newyork'` : restreint l'exécution aux hôtes qui sont simultanément dans les groupes **webservers** et **newyork**.
- `-t update` : exécute uniquement les tâches associées au **tag** **update**, ce qui exclut les tâches d'installation et de configuration de Nginx dans ce cas.
- `-v` : augmente la verbosité pour fournir plus de détails sur l'exécution des tâches.

### 3.2.1 Explications détaillées sur la sortie

Voici le format de sortie de l'exécution de la commande **ansible-playbook** sans option particulière :

```SHELL
PLAY [Setting up Nginx on web servers] ****************************************

TASK [Gathering Facts] ********************************************************
ok: [webservers]

TASK [Install Nginx] **********************************************************
changed: [webservers]

TASK [Copy configuration file of Nginx] ***************************************
changed: [webservers]

PLAY RECAP ********************************************************************
webservers: ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

PLAY [Update database servers] ************************************************

TASK [Gathering Facts] ********************************************************
ok: [databases]

TASK [Update all packages]] ***************************************************
changed: [databases]

PLAY RECAP ********************************************************************
databases: ok=3    changed=2    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
```

- **Nom du play** : chaque **play** commence par afficher son nom, facilitant la compréhension de quelle partie du **playbook** est actuellement exécutée.
- **Gathering facts** : par défaut, **Ansible** collecte des informations (des **facts**) sur les hôtes ciblés avant d'exécuter les tâches. Cette étape peut être désactivée avec l'option **gather_facts: false**. ok indique que l'action a réussi sans modifications sur l'hôte.
- **Tâches** :
  - Chaque tâche est listée avec son nom suivi du résultat. **changed** signifie que la tâche a modifié quelque chose sur l'hôte. **ok** indiquerait qu'aucun changement n'a été nécessaire.
  - **failed**, **unreachable**, **skipped**, **rescued**, et **ignored** sont d'autres statuts possibles, indiquant respectivement un échec, une inaccessibilité, une omission, un sauvetage d'erreur, et qu'elle a été ignorée.
- **Play RECAP** : à la fin de chaque **play**, un récapitulatif est affiché, montrant le nombre de tâches qui ont eu chaque statut (**ok**, **changed**, etc.). Cela donne une vue d'ensemble rapide de ce qui s'est passé pendant ce **play**.
