# 4. Vérifier et valider ses playbooks

## 4.1. Vérification des playbooks

La vérification des playbooks **Ansible** est une étape cruciale dans le développement et le déploiement de configurations automatisées.

Elle permet d'identifier les erreurs de syntaxe et autres problèmes potentiels avant l'exécution réelle des **playbooks** sur des cibles de production.

Nous allons voir les outils de vérification disponibles dans la commande **ansible-playbook** et un aperçu des outils supplémentaires pour la validation des **playbooks**.

## 4.2. Vérification avec ansible-playbook

**--syntax-check** : cette option permet de vérifier la syntaxe de vos **playbooks**. Elle ne fait rien d'autre que de parcourir le **playbook** et de vérifier qu'il n'y a pas d'erreurs de syntaxe flagrantes.

```SHELL
ansible-playbook playbook.yml --syntax-check
```

**--list-tasks** : affiche la liste de toutes les tâches qui seront exécutées par le **playbook**, sans les exécuter. Cela donne un aperçu de ce qui sera fait, dans quel ordre, et permet de vérifier la logique du **playbook**.

```SHELL
ansible-playbook playbook.yml --list-tasks
```

**--list-host**s : affiche tous les hôtes qui seront ciblés par le **playbook**. C'est utile pour vérifier si les hôtes cibles correspondent à ce que vous attendiez, ce qui est particulièrement important dans des environnements complexes.

```SHELL
ansible-playbook playbook.yml --list-hosts
```

**--check** : exécute le **playbook** en mode "**dry run**", c'est-à-dire qu'il simule l'exécution sans apporter de modifications réelles aux hôtes cibles. Cela peut aider à identifier des erreurs logiques ou des problèmes d'exécution potentiels.

```SHELL
ansible-playbook playbook.yml --check
```

**--diff** : utilisé conjointement avec l'option **--check**, cette option montre les différences que le **playbook** aurait apportées s'il avait été exécuté normalement. Cela vous permet de voir ce qui aurait changé et peut aider à affiner vos **playbooks** avant de les exécuter sur des environnements de production.

```SHELL
ansible-playbook playbook.yml --check --diff
```

## 4.3. Utiliser ansible-lint

**Ansible Lint** est un outil de vérification de syntaxe (**linting**) spécialement conçu pour les **playbooks**, rôles et collections d'**Ansible**.

Cet outil est utilisé pour analyser des projets **Ansible** en quête de pratiques, patterns et comportements recommandés, tout en identifiant les pièges courants qui pourraient mener à des erreurs ou rendre le code plus difficile à maintenir.

L'objectif principal d'**Ansible Lint** est de promouvoir l'adoption de bonnes pratiques en fournissant des retours immédiats sur les erreurs potentielles ou les mauvaises pratiques dans les scripts **Ansible**. Cela aide à améliorer la qualité du code et à préparer les utilisateurs à utiliser les versions les plus récentes d'**Ansible**.

### 4.3.1. Fonctionnement

**Ansible Lint** vérifie les **playbooks**, les rôles et les collections contre une série de règles prédéfinies.

Les règles sont définies par la communauté et peuvent être activées ou désactivées individuellement par l'utilisateur, permettant une personnalisation selon les besoins spécifiques du projet.

Les règles couvrent divers aspects, y compris mais sans se limiter à :

- L'utilisation correcte de l'indentation et des espacements.
- La mise en oeuvre sûre des tâches.
- L'utilisation appropriée des variables.
- La détection de pratiques dépréciées ou potentiellement dangereuses.

### 4.3.2. Installation

Pour l'installer :

```SHELL
pip install ansible-lint
```

### 4.3.3. Exemple de sortie

Pour utiliser **Ansible Lint**, naviguez dans votre terminal jusqu'au dossier contenant vos fichiers **Ansible** et exécutez la commande suivante :

```SHELL
ansible-lint
```

Cela analysera tous les fichiers Ansible dans le répertoire actuel.

Vous pouvez également spécifier un fichier ou un répertoire particulier :

```SHELL
ansible-lint playbooks/
```

```SHELL
WARNING  Listing 8 violation(s) that are fatal
yaml[truthy]: Truthy value should be one of [false, true]
playbooks/check_and_install_python.yml:3

yaml[truthy]: Truthy value should be one of [false, true]
playbooks/check_and_install_python.yml:4

fqcn[action-core]: Use FQCN for builtin module actions (command).
playbooks/check_and_install_python.yml:7 Use `ansible.builtin.command` or `ansible.legacy.command` instead.

fqcn[action-core]: Use FQCN for builtin module actions (raw).
playbooks/check_and_install_python.yml:13 Use `ansible.builtin.raw` or `ansible.legacy.raw` instead.

no-changed-when: Commands should not change things if nothing needs doing.
playbooks/check_and_install_python.yml:13 Task/Handler: Installer s'il n'est pas présent

yaml[truthy]: Truthy value should be one of [false, true]
playbooks/setup_known_hosts.yml:3

fqcn[action-core]: Use FQCN for builtin module actions (known_hosts).
playbooks/setup_known_hosts.yml:5 Use `ansible.builtin.known_hosts` or `ansible.legacy.known_hosts` instead.

jinja[spacing]: Jinja2 spacing could be improved: {{ lookup('env','HOME') }}/.ssh/known_hosts -> {{ lookup('env', 'HOME') }}/.ssh/known_hosts (warning)
playbooks/setup_known_hosts.yml:7 Jinja2 template rewrite recommendation: `{{ lookup('env', 'HOME') }}/.ssh/known_hosts`.

Read documentation for instructions on how to ignore specific rule violations.

                    Rule Violation Summary
 count tag               profile    rule associated tags
     1 jinja[spacing]    basic      formatting (warning)
     3 yaml[truthy]      basic      formatting, yaml
     1 no-changed-when   shared     command-shell, idempotency
     3 fqcn[action-core] production formatting

Failed: 7 failure(s), 1 warning(s) on 3 files. Last profile that met the validation criteria was 'min'.
```

### 4.3.4. Extensions et configuration

Il est possible de configurer **Ansible Lin**t via un fichier de configuration **.ansible-lint** où vous pouvez définir des exclusions spécifiques, configurer des règles personnalisées ou ajuster les paramètres par défaut.

Nous ne le verrons pas en détail car il y a énormément de configuration disponibles. Mais vous pouvez les [retrouver ici](https://ansible.readthedocs.io/projects/lint/configuring/#pre-commit-setup).
