# 1. Syntaxes et formats des inventaires

## 1.1. Formats d'inventaire

**Ansible** supporte différents formats d'inventaire, les plus courants étant **INI** et **YAML**.

_Le format **INI** est un format pour les fichiers de configuration créé par **Microsoft** avec le système d'exploitation **Windows** 1.0 en 1985_

Dans la formation nous utiliserons le **YAML** qui est plus clair mais nous présenterons quand même le format **INI** car il faut le connaître si vous rencontrez des configurations dans ce format.

### Exemple d'inventaire en INI

```INI
mail.example.com

[webservers]
foo.example.com
bar.example.com

[dbservers]
one.example.com
two.example.com
three.example.com
```

### Même inventaire en YAML

```YAML
ungrouped:
  hosts:
    mail.example.com: ~
webservers:
  hosts:
    foo.example.com: ~
    bar.example.com: ~
dbservers:
  hosts:
    one.example.com: ~
    two.example.com: ~
    three.example.com: ~
```

## 1.2. Les groupes

**En général on groupe les hôtes par fonction et / ou par localisation**.

Par exemple, groupe des serveurs en Europe, groupe des serveurs de base de données etc.

### 1.2.1. Groupes par défaut

**Ansible** crée automatiquement deux groupes : **all**, qui contient tous les hôtes, et **ungrouped**, qui contient les hôtes qui ne sont pas dans un autre groupe.

### 1.2.2. Hôtes dans plusieurs groupes

Un hôte peut appartenir à plusieurs groupes, ce qui permet de classer les hôtes de différentes manières (par exemple, par application, emplacement, environnement).

Voici à quoi pourrait ressembler une architecture complète :

```YAML
# WEB servers
servers_web:
  hosts:
    server_web_1:
    server_web_2:
    server_web_3:
    server_web_4:

# DATABASE servers
servers_db:
  hosts:
    server_db_1:
    server_db_2:
    server_db_3:
    server_db_4:

# CACHE servers
servers_cache:
  hosts:
    server_cache_1:

# PROD environment
production:
  hosts:
    server_web_1:
    server_web_2:
    server_db_1:
    server_db_2:
    server_cache_1:

# INTEGRATIOn environment
integration:
  hosts:
    serveur_web_3:
    serveur_db_3:

# TEST environment
test:
  hosts:
    server_web_4:
    server_db_4:

# List of server that require higher monitoring
monitoring:
  hosts:
    server_web_1:
    server_web_2:
    server_db_1:
    server_db_2:
    server_cache_1:
```

Dans cet exemple :

- **server_web_1** et **server_web_2** appartiennent aux groupes **servers_web**, **production** et **monitoring**.
- **server_db_1** et **server_db_2** appartiennent aux groupes **servers_db**, **production** et **monitoring**.
- **server_cache_1** appartient aux groupes **servers_cache**, **production** et **monitoring**.
- **server_web_3** appartient aux groupes **servers_web**, **integration**.
- **server_db_3** appartient aux groupes **servers_db**, **integration**.
- **server_web_4** appartient aux groupes **servers_web**, **test**.
- **server_db_4** appartient aux groupes **servers_db**, **test**.

Ainsi, vous pouvez voir que chaque serveur peut appartenir à plusieurs groupes selon son rôle et son environnement, facilitant la gestion et l'automatisation avec **Ansible**.

## 1.3. Relations parent / enfant entre les Groupes

Vous pouvez créer des relations entre les groupes pour organiser votre inventaire de manière hiérarchique.

Dans le format **YAML**, il faut utiliser l'**entrée children** :

```YAML
paris:
  children:
    webservers:
    dbservers:
france:
  children:
    paris:
    lyon:
prod:
  children:
    france:
test:
  children:
    europe:
```

## 1.4. Ajout de plages d'hôtes

Vous pouvez ajouter des plages d'hôtes au lieu de les lister un par un, ce qui est utile pour les hôtes avec des noms suivant un motif similaire.

```YAML
web:
  hosts:
    web[01:05].example.com:
db:
  hosts:
    db[01:05].example.com:
cache:
  hosts:
    cache[01:05].example.com:
search:
  hosts:
    search[01:05].example.com:
app:
  hosts:
    app[01:05].example.com:
```

## 1.5. Organisation de l'inventaire dans un répertoire

Vous pouvez organiser votre inventaire en répertoires, ce qui facilite la gestion de sources d'inventaire multiples.

Voici à quoi pourrait ressembler une architecture complète organisée en répertoire :

```TEXT
inventaire/
│
├── production/                # Dossier pour l'environnement de production
│   ├── servers_web.yml        # Inventaire des serveurs web en production
│   ├── servers_bd.yml         # Inventaire des serveurs de base de données en production
│   └── group_vars/            # Variables spécifiques à l'environnement de production
│       ├── servers_web.yml    # Variables pour les serveurs web en production
│       └── servers_bd.yml     # Variables pour les serveurs de base de données en production
│
├── test/                      # Dossier pour l'environnement de test
│   ├── servers_web.yml        # Inventaire des serveurs web en test
│   ├── servers_bd.yml         # Inventaire des serveurs de base de données en test
│   └── group_vars/            # Variables spécifiques à l'environnement de test
│       ├── servers_web.yml    # Variables pour les serveurs web en test
│       └── servers_bd.yml     # Variables pour les serveurs de base de données en test
│
└── scripts_inventaire/        # Scripts d'inventaire dynamique
    ├── aws_ec2.py             # Script d'inventaire pour les instances EC2 AWS
    └── vmware_vm_inventory.py # Script d'inventaire pour les VMs VMware
```

Et voici un exemple de contenu d'un de ces fichiers, par exemple le fichier `inventaire/production/serveurs_web.yml` :

```YAML
servers_web:
  hosts:
    web_prod_1:
      ansible_host: 192.168.1.101
    web_prod_2:
      ansible_host: 192.168.1.102
```

Il suffirait ensuite, pour déployer l'environnement de production de faire :

```SHELL
ansible-playbook -i inventaire/production deploy.yml
```

## 1.6. Gestion de l'ordre de chargement de l'inventaire

L'ordre de chargement des sources d'inventaire est important, en particulier lorsque vous définissez des relations parent/enfant entre les groupes.

**Ansible** charge les sources d'inventaire en ordre **ASCII** selon les noms de fichier. Si les groupes parents sont chargés avant les groupes enfants, une erreur peut survenir.
