# 5. Le module apt

## 5.1. Le module apt

Le module `ansible.builtin.apt` permet de gérer les paquets **apt** pour les systèmes basés sur **Debian/Ubuntu**.

Il existe également le module **yum** pour les systèmes comme **Fedora**, **rehl**, **CentOS** ou encore **Amazon Linux 2**.

_Son fonctionnement est très similaire au module **apt** donc nous ne le verrons pas en plus_.

## 5.2. Paramètres

Voici la liste exhaustive des paramètres :

- **allow_change_held_packages** : permet de modifier la version d'un paquet retenu sur la liste des paquets en attente.
- **allow_downgrade** : permet de remplacer un paquet déjà installé par une version inférieure.
- **allow_unauthenticated** : installe des paquets même si leur authenticité ne peut être vérifiée.
- **autoclean** : nettoie le dépôt local des fichiers de paquets qui ne peuvent plus être téléchargés.
- **autoremove** : supprime les paquets dépendants qui ne sont plus utilisés.
- **cache_valid_time** : met à jour le cache des paquets si celui-ci est plus vieux que la durée spécifiée en secondes.
- **clean** : vide le dépôt local des fichiers de paquets téléchargés, excepté le fichier de verrou.
- **deb** : chemin vers un fichier paquet `.deb` à installer.
- **default_release** : spécifie une version par défaut pour les paquets à installer ou mettre à jour.
- **dpkg_options** : ajoute des options spécifiques à dpkg lors de l'exécution de la commande apt.
- **fail_on_autoremove** : échoue si l'opération entraînerait la suppression de paquets.
- **force** : force l'installation de paquets sans authentification et permet les downgrades.
- **force_apt_get** : utilise **apt-get** à la place de **aptitude**.
- **install_recommends** : spécifie si les paquets recommandés doivent être installés avec le paquet principal.
- **lock_timeout** : délai en secondes pour obtenir un verrou sur la base de données apt avant d'échouer.
- **name** : liste des noms de paquets à installer, mettre à jour ou supprimer.
- **only_upgrade** : met à jour les paquets seulement s'ils sont déjà installés.
- **policy_rc_d** : force le code de retour de `/usr/sbin/policy-rc.d`.
- **purge** : supprime les fichiers de configuration des paquets supprimés.
- **state** : indique l'état désiré pour les paquets spécifiés :
  - **absent** : utilisé pour s'assurer qu'un paquet n'est pas installé sur le système. Si le paquet est présent, il sera supprimé.
  - **build-dep** : cette option permet d'installer toutes les dépendances nécessaires pour construire un paquet à partir des sources. C'est utile lorsque vous prévoyez de compiler un paquet et avez besoin de toutes les bibliothèques et outils requis pour le processus de construction.
  - **latest** : assure que la dernière version d'un paquet est installée. Si une version plus récente est disponible dans les dépôts que celle qui est actuellement installée, elle sera mise à jour. Si le paquet n'est pas installé, la dernière version disponible sera installée.
  - **present** (valeur par défaut) : garantit que le paquet est installé. Si le paquet n'est pas présent sur le système, il sera installé. Si le paquet est déjà installé, aucune action ne sera prise, à moins qu'une version spécifique ne soit demandée et que cette version soit différente de celle déjà installée.
  - **fixed** : cette option tente de corriger un système qui a des dépendances cassées. Si des paquets sont installés mais présentent des problèmes de dépendances non résolues, cette option tentera de résoudre ces problèmes en installant, en mettant à jour ou en supprimant des paquets pour corriger l'état des dépendances.
- **update_cache** : met à jour le cache des paquets avant d'exécuter une opération.
- **update_cache_retries** : nombre de tentatives en cas d'échec de la mise à jour du cache.
- **update_cache_retry_max_delay** : délai maximal entre les tentatives de mise à jour du cache.
- **upgrade** : spécifie le type de mise à niveau des paquets à effectuer.

## 5.3. Exemples

### Installer NGINX

```YAML
- name: Install NGINX
  ansible.builtin.apt:
    name: nginx
    state: present
```

### Mettre à jour le cache des dépôts et installer un paquet

```YAML
- name: Update cache of repositories and install "software" package
  ansible.builtin.apt:
    name: software
    update_cache: yes
```

### Supprimer un paquet

```YAML
- name: Remove "software" package
  ansible.builtin.apt:
    name: software
    state: absent
```

### Installer une liste de paquets

```YAML
- name: Install list of packages
  ansible.builtin.apt:
    pkg:
    - software
    - software-tools
    - software-utils
```

### Installer une version spécifique d'un paquet

```YAML
- name: Install version 2.0 of "software"
  ansible.builtin.apt:
    name: software=2.0
```

### Mettre à jour tous les paquets à leur dernière version

```YAML
- name: Update to latest version all packages
  ansible.builtin.apt:
    name: "*"
    state: latest
```

### Mise à jour du système d'exploitation (`apt-get dist-upgrade`)

```YAML
- name: Update operating system
  ansible.builtin.apt:
    upgrade: dist
```

### Supprimer les dépendances devenus inutiles et purger leurs fichiers de configuration

```YAML
- name: Remove unnecessary dependencies and purge their configuration files
  ansible.builtin.apt:
    autoremove: yes
    purge: true
```
