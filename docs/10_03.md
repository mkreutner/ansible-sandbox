# 3. Délégation des tâches

## 3.1. Qu'est-ce que la délégation de tâche ?

La délégation des tâches dans **Ansible** permet d'exécuter des tâches sur un hôte différent de celui sur lequel elles seraient normalement exécutées.

C'est particulièrement utile dans des scénarios où une tâche doit être exécutée sur une machine de contrôle plutôt que sur les hôtes cibles.

Le mot-clé **delegate_to** est utilisé pour déléguer l'exécution d'une tâche à un hôte spécifique autre que l'hôte sur lequel la tâche serait normalement exécutée. C'est particulièrement utile lorsque vous devez exécuter des tâches de gestion centralisée ou des opérations nécessitant une intervention sur un hôte spécifique.

Le mot-clé **local_action** est une syntaxe abrégée pour déléguer une tâche à la machine de contrôle (souvent **localhost** ou **127.0.0.1**). Il est utilisé principalement pour des tâches qui doivent être exécutées localement sur la machine exécutant Ansible, comme des commandes locales ou des opérations nécessitant des ressources locales.

### En résumé :

**delegate_to** peut déléguer l'exécution à n'importe quel hôte spécifié, y compris ceux définis par des adresses **IP**, des noms **DNS** ou des noms d'hôtes dans l'inventaire.
**local_action** délègue spécifiquement l'exécution à la machine de contrôle (**localhost**).

## 3.2. Pourquoi utiliser la délégation de tâches ?

Voici des exemples communs d'utilisation de la délégation de tâches :

1. **Gestion d'un load balancer** : lorsque vous mettez à jour des serveurs web, vous pouvez avoir besoin de les retirer temporairement d'un pool de **load balancer**, une tâche qui ne peut pas être exécutée sur les serveurs web eux-mêmes.
2. **Déploiement centralisé** : déployer des configurations ou des fichiers depuis une machine de gestion centrale à plusieurs serveurs cibles.
3. **Collecte de faits centralisée** : collecter des informations à partir de différents groupes de serveurs depuis une machine unique.

## 3.3. Exemples

### 3.3.1. Gestion de load balancer

Supposons que vous avez plusieurs serveurs web derrière un **load balancer**.

Avant de les mettre à jour, vous devez les retirer du **pool** de **load balancer**, puis les réintégrer une fois la mise à jour terminée.

```YAML
- hosts: webservers
  serial: 5

  tasks:
    - name: Remove from the load balancing pool
      ansible.builtin.command: /usr/bin/take_out_of_pool {{ inventory_hostname }}
      delegate_to: 127.0.0.1

    - name: Update the web server
      ansible.builtin.yum:
        name: acme-web-stack
        state: latest

    - name: Reintegrate into the load balancing pool
      ansible.builtin.command: /usr/bin/add_back_to_pool {{ inventory_hostname }}
      delegate_to: 127.0.0.1
```

**Dans cet exemple** :

- les tâches de retrait et de réintégration au **pool** d'équilibrage de charge sont exécutées sur **127.0.0.1** (la machine exécutant **Ansible**).
- la mise à jour des serveurs Web est exécutée sur chaque hôte dans le groupe **webservers**.

### 3.3.2. Copier de fichiers avec rsync

Vous pouvez vouloir copier des fichiers depuis une machine de gestion centrale vers plusieurs serveurs cibles en utilisant **rsync**.

```YAML
---
- hosts: webservers

  tasks:
    - name: Recursively copy files from the management server to the target
      local_action: ansible.builtin.command rsync -a /path/to/files {{ inventory_hostname }}:/path/to/target/
```

La commande **rsync** est exécutée localement sur la machine de gestion (**127.0.0.1**) pour copier des fichiers vers chaque serveur web cible.
